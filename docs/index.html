<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareRisk - Évaluation des Risques Patients</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e9f7ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }
        header {
            background-color: #0056b3;
            color: white;
            padding: 20px;
            text-align: center;
            width: 100%;
            cursor: pointer;
        }
        nav {
            background-color: #007bff;
            width: 100%;
            padding: 10px;
            text-align: center;
        }
        nav button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #0056b3;
        }
        nav button:hover {
            background-color: #e0e0e0;
        }
        .container {
            max-width: 880px;
            width: 100%;
            padding: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.07);
            margin: 20px 0;
            border-radius: 8px;
        }
        form {
            display: flex;
            flex-direction: column;
        }
        label.eval-critere {
            margin-bottom: 6px;
            margin-top: 12px;
        }
        input, select, button, textarea {
            margin: 4px 0 12px 0;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        textarea {
            resize: vertical;
        }
        button {
            background-color: #28a745;
            color: white;
            cursor: pointer;
        }
        button[type="button"]:not([onclick]), button.annuler-btn {
            background-color: #aaa;
        }
        button:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }
        .risk-section {
            margin: 22px 0 25px 0;
            background-color: #f8f9fa;
            padding: 18px 12px 18px 12px;
            border-radius: 8px;
        }
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .alert-high, .critere-gravite.eleve {
            background-color: #c0392b !important;
            color: white !important;
        }
        .alert-moderate, .critere-gravite.modere {
            background-color: #d35400 !important;
            color: white !important;
        }
        .alert-low, .critere-gravite.faible {
            background-color: #f1c40f !important;
            color: #000 !important;
        }
        .critere-gravite {
            font-weight: bold;
            padding: 7px 16px;
            margin-top: 4px;
            margin-bottom: 14px;
            display: inline-block;
            border-radius: 2.5px;
        }
        .device-critical {
            color: #c0392b;
            font-weight: bold;
        }
        .device-ok {
            color: #28a745;
            font-weight: bold;
        }
        #admin-controls {
            margin-top: 24px;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            background-color: #f8f9fa;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .patient-meta {
            font-size: 0.89em;
            color: #888;
            margin-top: 2px;
            line-height: 1.3;
        }
        .plan-historique {
            font-size: 0.9em;
            margin-top: 9px;
        }
        .plan-historique-entry {
            margin-bottom: 4px;
        }
        .plan-update-btn {
            margin-top: 8px;
            background-color: #007bff !important;
        }
        .plan-update-btn:hover {
            background-color: #0056b3 !important;
        }
        @media (max-width: 600px) {
            .container {
                padding: 8px;
            }
            input, select, button {
                font-size: 14px;
            }
            nav button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <header onclick="goHome()" title="Retour à l'accueil">
        <h1>CareRisk - Évaluation des Risques Patients</h1>
    </header>

    <!-- Page d'accueil -->
    <div id="home" class="container">
        <p>Carerisk transforme la sécurité des patients. Notre application centralise et structure la gestion des risques cliniques pour tous les patients hospitalisés.</p>
        <p>En exigeant une connexion sécurisée via le compte CMD et en limitant le partage des rapports aux membres du même service, Carerisk assure à la fois la collaboration ciblée des équipes et la confidentialité stricte des données.</p>
        <p>Contact administrateur : zbawab@cmd.cd</p>

        <form id="login-form" onsubmit="login(); return false;">
            <label for="full-name">Nom complet</label>
            <input type="text" id="full-name" required placeholder="Entrez votre nom complet">
            <label for="email">Compte mail CMD</label>
            <input type="email" id="email" required placeholder="prenom.nom@cmd.cd">
            <label for="service">Service</label>
            <select id="service" required>
                <option>-- Sélectionnez le service --</option>
                <option>Médecine</option>
                <option>Chirurgie</option>
                <option>Maternité</option>
                <option>Pédiatrie</option>
                <option>Soins Intensifs</option>
            </select>
            <button type="submit">Se connecter</button>
        </form>
    </div>

    <nav id="nav" class="hidden">
        <button onclick="showSection('patients')">Liste des Patients</button>
        <button onclick="showSection('evaluation')">Évaluation</button>
        <button onclick="showSection('care-plans')">Plans de soins</button>
        <button onclick="showSection('devices')">Dispositifs</button>
        <button id="admin-nav-btn" class="hidden" onclick="showSection('admin-controls')">Admin</button>
    </nav>

    <div id="app" class="container hidden">
        <!-- Section Liste des Patients -->
        <section id="patients-section">
            <h2>Liste des patients</h2>
            <ul id="patient-list"></ul>
            <button onclick="showNewPatientForm()">Nouveau patient</button>
            <form id="new-patient-form" class="hidden" onsubmit="addPatient(); return false;">
                <label class="eval-critere" for="patient-name">Nom</label>
                <input type="text" id="patient-name" required placeholder="Nom du patient">
                <label class="eval-critere" for="patient-firstname">Prénom</label>
                <input type="text" id="patient-firstname" required placeholder="Prénom du patient">
                <label class="eval-critere" for="patient-age">Âge</label>
                <input type="number" id="patient-age" required min="0" max="120" placeholder="ex : 65">
                <label class="eval-critere" for="patient-room">Chambre</label>
                <input type="text" id="patient-room" required placeholder="Numéro de chambre">
                <label class="eval-critere" for="patient-diagnosis">Diagnostic principal</label>
                <input type="text" id="patient-diagnosis" required placeholder="Diagnostic principal">
                <button type="submit">Ajouter</button>
                <button type="button" class="annuler-btn" onclick="hideNewPatientForm()">Annuler</button>
            </form>
        </section>

        <!-- Section Évaluation -->
        <section id="evaluation-section" class="hidden">
            <h2>Évaluation des risques</h2>
            <label class="eval-critere" for="patient-select">Sélectionnez un patient</label>
            <select id="patient-select" onchange="updateEvalDevices()"></select>
            
            <!-- Risque d'escarres (Échelle de Braden) -->
            <div class="risk-section">
                <div class="risk-header">
                    <h3 style="margin:0;">Risque d'escarres (Échelle de Braden)</h3>
                </div>
                <label class="eval-critere">Perception sensorielle</label>
                <select id="braden-sensory">
                    <option value="1">Complètement limitée (1)</option>
                    <option value="2">Très limitée (2)</option>
                    <option value="3">Légèrement limitée (3)</option>
                    <option value="4">Aucune limitation (4)</option>
                </select>
                <label class="eval-critere">Humidité</label>
                <select id="braden-humidity">
                    <option value="1">Constamment humide (1)</option>
                    <option value="2">Très humide (2)</option>
                    <option value="3">Occasionnellement humide (3)</option>
                    <option value="4">Rarement humide (4)</option>
                </select>
                <label class="eval-critere">Activité</label>
                <select id="braden-activity">
                    <option value="1">Alité (1)</option>
                    <option value="2">En fauteuil (2)</option>
                    <option value="3">Marche occasionnellement (3)</option>
                    <option value="4">Marche fréquemment (4)</option>
                </select>
                <label class="eval-critere">Mobilité</label>
                <select id="braden-mobility">
                    <option value="1">Complètement immobile (1)</option>
                    <option value="2">Très limitée (2)</option>
                    <option value="3">Légèrement limitée (3)</option>
                    <option value="4">Aucune limitation (4)</option>
                </select>
                <label class="eval-critere">Nutrition</label>
                <select id="braden-nutrition">
                    <option value="1">Très pauvre (1)</option>
                    <option value="2">Probablement inadéquate (2)</option>
                    <option value="3">Adéquate (3)</option>
                    <option value="4">Excellente (4)</option>
                </select>
                <label class="eval-critere">Friction et cisaillement</label>
                <select id="braden-friction">
                    <option value="1">Problème (1)</option>
                    <option value="2">Problème potentiel (2)</option>
                    <option value="3">Aucun problème apparent (3)</option>
                </select>
                <p style="margin-bottom:0;">Score Braden: <span id="braden-score">0</span>/23</p>
                <span id="braden-gravite" class="critere-gravite"></span>
            </div>

            <!-- Risque de chutes (Échelle de Morse) -->
            <div class="risk-section">
                <div class="risk-header">
                    <h3 style="margin:0;">Risque de chutes (Échelle de Morse)</h3>
                </div>
                <label class="eval-critere">Historique de chutes</label>
                <select id="morse-history">
                    <option value="0">Non (0)</option>
                    <option value="25">Oui (25)</option>
                </select>
                <label class="eval-critere">Diagnostic secondaire</label>
                <select id="morse-secondary">
                    <option value="0">Non (0)</option>
                    <option value="15">Oui (15)</option>
                </select>
                <label class="eval-critere">Aide à la marche</label>
                <select id="morse-aid">
                    <option value="0">Aucune/lit/aide soignant (0)</option>
                    <option value="15">Béquilles/canne/déambulateur (15)</option>
                    <option value="30">Mobilier (30)</option>
                </select>
                <label class="eval-critere">Thérapie IV/accès veineux</label>
                <select id="morse-iv">
                    <option value="0">Non (0)</option>
                    <option value="20">Oui (20)</option>
                </select>
                <label class="eval-critere">Démarche</label>
                <select id="morse-gait">
                    <option value="0">Normale/lit/fauteuil roulant (0)</option>
                    <option value="10">Faible (10)</option>
                    <option value="20">Démarche altérée (20)</option>
                </select>
                <label class="eval-critere">État mental</label>
                <select id="morse-mental">
                    <option value="0">Orienté vers ses capacités (0)</option>
                    <option value="15">Surévalue ses capacités (15)</option>
                </select>
                <p style="margin-bottom:0;">Score Morse: <span id="morse-score">0</span>/125</p>
                <span id="morse-gravite" class="critere-gravite"></span>
            </div>

            <!-- Risque d'infection avec ajout dispositif -->
            <div class="risk-section">
                <div class="risk-header">
                    <h3 style="margin:0;">Risque d'infection</h3>
                    <button type="button" onclick="addDeviceFromEval()">Ajouter un dispositif</button>
                </div>
                <label class="eval-critere">Âge</label>
                <select id="infection-age">
                    <option value="0">&lt; 65 ans (0)</option>
                    <option value="1">65-80 ans (1)</option>
                    <option value="2">&gt; 80 ans (2)</option>
                </select>
                <label class="eval-critere">Immunosuppression</label>
                <select id="infection-immuno">
                    <option value="0">Non (0)</option>
                    <option value="2">Oui (2)</option>
                </select>
                <label class="eval-critere">Antibiotiques récents</label>
                <select id="infection-antibiotics">
                    <option value="0">Non (0)</option>
                    <option value="1">Oui (1)</option>
                </select>
                <label class="eval-critere">Chirurgie récente</label>
                <select id="infection-surgery">
                    <option value="0">Non (0)</option>
                    <option value="1">Oui (1)</option>
                </select>
                <label class="eval-critere">Comorbidités</label>
                <select id="infection-comorbidities">
                    <option value="0">Aucune (0)</option>
                    <option value="1">1-2 comorbidités (1)</option>
                    <option value="2">3+ comorbidités (2)</option>
                </select>
                <div style="margin-top:12px;">
                    <label class="eval-critere" style="font-size:1.02em; font-weight:600;">
                        Dispositifs invasifs pour ce patient
                    </label>
                    <ul id="devices-list"></ul>
                </div>
                <p style="margin-bottom:0;">Score dispositifs: <span id="devices-score">0</span></p>
                <p style="margin-bottom:0;">Score infection: <span id="infection-score">0</span>/10</p>
                <span id="infection-gravite" class="critere-gravite"></span>
            </div>
            <button onclick="calculateRisks()">Calculer les risques</button>
            <button onclick="generateCarePlan()">Générer plan de soins</button>
        </section>

        <!-- Section Plans de soins -->
        <section id="care-plans-section" class="hidden">
            <h2>Plans de soins générés</h2>
            <div id="care-plan-output"></div>
            <button id="download-plan" class="hidden" onclick="downloadCarePlan()">Télécharger le plan de soins</button>
        </section>

        <!-- Section Dispositifs -->
        <section id="devices-section" class="hidden">
            <h2>Gestion des Dispositifs Invasifs</h2>
            <button onclick="showNewDeviceForm()">Nouveau dispositif</button>
            <form id="new-device-form" class="hidden" onsubmit="addDevice(); return false;">
                <label class="eval-critere" for="device-patient">Patient</label>
                <select id="device-patient"></select>
                <label class="eval-critere" for="device-type">Type de dispositif</label>
                <select id="device-type">
                    <option>Sélectionner un type</option>
                    <option>Cathéter Central</option>
                    <option>Cathéter Périphérique</option>
                    <option>Sonde Urinaire</option>
                    <option>Intubation Endotrachéale</option>
                    <option>Drain Thoracique</option>
                    <option>Sonde Nasogastrique</option>
                    <option>Cathéter Épidural</option>
                    <option>Pace-maker Temporaire</option>
                    <option>Cathéter de Dialyse</option>
                    <option>Autre</option>
                </select>
                <label class="eval-critere" for="device-location">Localisation</label>
                <input type="text" id="device-location" required placeholder="Ex: membre supérieur droit">
                <label class="eval-critere" for="device-insertion">Date/Heure d'insertion</label>
                <input type="datetime-local" id="device-insertion" required>
                <label class="eval-critere" for="device-notes">Notes</label>
                <textarea id="device-notes" placeholder="Commentaires..."></textarea>
                <label class="eval-critere" for="device-criticality">Degré de criticité</label>
                <select id="device-criticality">
                    <option value="ok">Bon (vert)</option>
                    <option value="critical">À retirer (rouge)</option>
                </select>
                <button type="submit">Ajouter</button>
                <button type="button" class="annuler-btn" onclick="hideNewDeviceForm()">Annuler</button>
            </form>
            <ul id="devices-full-list"></ul>
        </section>

        <!-- Contrôles admin -->
        <section id="admin-controls" class="hidden">
            <h3>Contrôles Administrateur</h3>
            <label for="admin-patient-select">Sélectionnez un patient à supprimer</label>
            <select id="admin-patient-select"></select>
            <button onclick="deletePatient()">Supprimer patient</button>
            <label for="admin-plan-select">Sélectionnez un plan à supprimer</label>
            <select id="admin-plan-select"></select>
            <button onclick="deleteCarePlan()">Supprimer plan de soins</button>
        </section>
    </div>

    <script>
        let patients = [];
        let devices = [];
        let carePlans = [];
        let currentUserEmail = '';
        let currentUserFullName = '';
        let currentSection = 'patients';

        function goHome() {
            location.reload();
        }

        function login() {
            const email = document.getElementById('email').value;
            const fullName = document.getElementById('full-name').value;
            currentUserEmail = email;
            currentUserFullName = fullName;
            document.getElementById('home').classList.add('hidden');
            document.getElementById('nav').classList.remove('hidden');
            document.getElementById('app').classList.remove('hidden');
            if (email === 'zbawab@cmd.cd') {
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('admin-nav-btn').classList.remove('hidden');
            }
            loadData();
            showSection('patients');
        }

        function showSection(section) {
            let sections = ['patients-section','evaluation-section','care-plans-section','devices-section','admin-controls'];
            sections.forEach(id => {
                let el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            if (section === 'admin-controls') document.getElementById('admin-controls').classList.remove('hidden');
            else document.getElementById(`${section}-section`).classList.remove('hidden');
            currentSection = section;
            updateAdminSelects();
            if(section=="evaluation") updateEvalDevices();
        }

        function loadData() {
            // Données initiales
            patients = [
                { id: 0, name: 'Doe', firstname: 'John', age: 50, room: '101', diagnosis: 'Exemple',
                  createdAt: (new Date()).toLocaleString(), createdBy: 'Systeme'}
            ];
            devices = [];
            carePlans = [];
            updatePatientList();
            updatePatientSelects();
            updateDevicesList();
        }

        // PATIENTS
        function showNewPatientForm() {
            document.getElementById('new-patient-form').reset();
            document.getElementById('new-patient-form').classList.remove('hidden');
        }
        function hideNewPatientForm() {
            document.getElementById('new-patient-form').classList.add('hidden');
        }
        function addPatient() {
            const patient = {
                id: patients.length>0 ? Math.max(...patients.map(p=>p.id))+1 : 0,
                name: document.getElementById('patient-name').value,
                firstname: document.getElementById('patient-firstname').value,
                age: document.getElementById('patient-age').value,
                room: document.getElementById('patient-room').value,
                diagnosis: document.getElementById('patient-diagnosis').value,
                createdAt: (new Date()).toLocaleString(),
                createdBy: currentUserFullName
            };
            patients.push(patient);
            updatePatientList();
            updatePatientSelects();
            hideNewPatientForm();
        }
        function updatePatientList() {
            const list = document.getElementById('patient-list');
            list.innerHTML = '';
            patients.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.name} ${p.firstname} - Âge: ${p.age} - Chambre: ${p.room}`;
                const meta = document.createElement('div');
                meta.className = "patient-meta";
                meta.textContent = `Ajouté le ${p.createdAt ?? ''} par ${p.createdBy ?? ''}`;
                li.appendChild(meta);
                list.appendChild(li);
            });
        }
        function updatePatientSelects() {
            const selects = [
                document.getElementById('patient-select'),
                document.getElementById('device-patient'),
                document.getElementById('admin-patient-select')
            ];
            selects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Sélectionner un patient...</option>';
                    patients.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = `${p.name} ${p.firstname}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        // EVALUATION
        function calculateRisks() {
            // BRADEN
            const braden = 
                  parseInt(document.getElementById('braden-sensory').value)
                + parseInt(document.getElementById('braden-humidity').value)
                + parseInt(document.getElementById('braden-activity').value)
                + parseInt(document.getElementById('braden-mobility').value)
                + parseInt(document.getElementById('braden-nutrition').value)
                + parseInt(document.getElementById('braden-friction').value);
            document.getElementById('braden-score').textContent = braden;
            // Braden gravité
            let bradenRisq = '';
            let bradenC = '';
            if (braden <= 12) { bradenRisq = "Risque élevé"; bradenC="eleve"; }
            else if (braden <= 16) { bradenRisq = "Risque modéré"; bradenC="modere";}
            else { bradenRisq = "Risque faible"; bradenC="faible";}
            document.getElementById('braden-gravite').textContent = bradenRisq;
            document.getElementById('braden-gravite').className = 'critere-gravite ' + bradenC;

            // MORSE
            const morse = 
                parseInt(document.getElementById('morse-history').value)
                + parseInt(document.getElementById('morse-secondary').value)
                + parseInt(document.getElementById('morse-aid').value)
                + parseInt(document.getElementById('morse-iv').value)
                + parseInt(document.getElementById('morse-gait').value)
                + parseInt(document.getElementById('morse-mental').value);
            document.getElementById('morse-score').textContent = morse;
            // Morse gravité
            let morseRisq = '';
            let morseC = '';
            if(morse >= 51) { morseRisq="Risque élevé"; morseC="eleve";}
            else if(morse >= 25) { morseRisq="Risque modéré"; morseC="modere";}
            else { morseRisq="Risque faible"; morseC="faible";}
            document.getElementById('morse-gravite').textContent = morseRisq;
            document.getElementById('morse-gravite').className = 'critere-gravite '+ morseC;

            // INFECTION (uniquement dispositifs du patient sélectionné)
            const pid = document.getElementById('patient-select').value;
            const patientDevices = devices.filter(d => d.patientId == pid);
            const devicesScore = patientDevices.reduce((sum, d) => sum + (d.criticality === 'critical' ? 2 : 1), 0);
            document.getElementById('devices-score').textContent = devicesScore;

            const infection = 
                parseInt(document.getElementById('infection-age').value)
                + parseInt(document.getElementById('infection-immuno').value)
                + parseInt(document.getElementById('infection-antibiotics').value)
                + parseInt(document.getElementById('infection-surgery').value)
                + parseInt(document.getElementById('infection-comorbidities').value)
                + devicesScore;
            document.getElementById('infection-score').textContent = Math.min(infection, 10);

            // Infection gravité
            let infRisq = '';
            let infC = '';
            if(infection >= 7) { infRisq="Risque élevé"; infC="eleve";}
            else if(infection >= 4) { infRisq="Risque modéré"; infC="modere";}
            else {infRisq="Risque faible"; infC="faible";}
            document.getElementById('infection-gravite').textContent = infRisq;
            document.getElementById('infection-gravite').className = 'critere-gravite '+infC;
        }

        function generateCarePlan(isUpdate = false, updatePlanId=null) {
            const selectedPatientId = document.getElementById('patient-select').value;
            if (selectedPatientId === '' || selectedPatientId=="Sélectionner un patient...") {
                alert("Sélectionnez un patient !");
                return;
            }
            const patient = patients.find(p => p.id == selectedPatientId);
            const risks = {
                braden: parseInt(document.getElementById('braden-score').textContent),
                morse: parseInt(document.getElementById('morse-score').textContent),
                infection: parseInt(document.getElementById('infection-score').textContent)
            };
            let now = (new Date()).toLocaleString();
            let by = currentUserFullName;
            if(isUpdate && updatePlanId!=null){
                let plan = carePlans.find(p=>p.id==updatePlanId);
                if(plan){
                    if(!plan.history) plan.history=[];
                    plan.history.push({
                        date: now,
                        by: by,
                        risks: plan.risks
                    });
                    plan.risks = risks;
                    plan.lastUpdate = now;
                    plan.lastUpdateBy = by;
                }
            } else {
                const plan = {
                    id: carePlans.length>0 ? Math.max(...carePlans.map(p=>p.id))+1 : 0,
                    patient: patient,
                    risks: risks,
                    createdAt: now,
                    createdBy: by,
                    history: [],
                    lastUpdate: now,
                    lastUpdateBy: by
                };
                carePlans.push(plan);
            }
            updateCarePlans();
            document.getElementById('download-plan').classList.remove('hidden');
        }

        function updateCarePlans() {
            const output = document.getElementById('care-plan-output');
            output.innerHTML = '';
            carePlans.forEach(cp => {
                let bradenLevel = cp.risks.braden <= 12 ? 'high' : (cp.risks.braden <= 16 ? 'moderate' : 'low');
                let morseLevel = cp.risks.morse >= 51 ? 'high' : (cp.risks.morse >= 25 ? 'moderate' : 'low');
                let infectionLevel = cp.risks.infection >= 7 ? 'high' : (cp.risks.infection >= 4 ? 'moderate' : 'low');
                // Libellés
                let bradenLbl = (bradenLevel=="high"? "Risque élevé": bradenLevel=="moderate"? "Risque modéré":"Risque faible");
                let morseLbl = (morseLevel=="high"? "Risque élevé": morseLevel=="moderate"? "Risque modéré":"Risque faible");
                let infLbl = (infectionLevel=="high"? "Risque élevé": infectionLevel=="moderate"? "Risque modéré":"Risque faible");
                const div = document.createElement('div');
                div.innerHTML = `
                    <p><b>Plan pour ${cp.patient.name} ${cp.patient.firstname}:</b> <span style="font-size:0.97em; color:#888;">(créé le ${cp.createdAt} par ${cp.createdBy})</span></p>
                    <p class="alert-${bradenLevel}">Risque escarres: ${bradenLbl} (Score: ${cp.risks.braden})</p>
                    <p class="alert-${morseLevel}">Risque chutes: ${morseLbl} (Score: ${cp.risks.morse})</p>
                    <p class="alert-${infectionLevel}">Risque infection: ${infLbl} (Score: ${cp.risks.infection})</p>
                    <button class="plan-update-btn" onclick="updatePlanDialog(${cp.id})">Mettre à jour ce plan</button>
                    <div class="plan-historique">
                        <b>Historique de mises à jour :</b>
                        ${(cp.history && cp.history.length>0) ? cp.history.map(h => 
                            `<div class="plan-historique-entry">Modifié le <b>${h.date}</b> par <i>${h.by}</i>
                            (Braden: ${h.risks.braden}/23, Morse:${h.risks.morse}/125, Infection:${h.risks.infection}/10)</div>`).join('') : '<div>Aucune mise à jour.</div>'}
                        <div class="plan-historique-entry" style="color:#007bff;"><b>Dernière modification</b> : ${cp.lastUpdate} par ${cp.lastUpdateBy}</div>
                    </div>
                `;
                output.appendChild(div);
            });
            // Mise à jour select admin
            const planSelect = document.getElementById('admin-plan-select');
            if(planSelect){
                planSelect.innerHTML = '<option value="">Sélectionner un plan...</option>';
                carePlans.forEach(cp => {
                    const option = document.createElement('option');
                    option.value = cp.id;
                    option.textContent = `Plan pour ${cp.patient.name} ${cp.patient.firstname}`;
                    planSelect.appendChild(option);
                });
            }
        }

        function downloadCarePlan() {
            const content = carePlans.map(cp => 
                `Plan pour ${cp.patient.name}: Scores - Braden: ${cp.risks.braden}, Morse: ${cp.risks.morse}, Infection: ${cp.risks.infection}`
                ).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plans_de_soins.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // FONCTION update plan : re-remplit les critères puis regénère le plan
        function updatePlanDialog(planId){
            const cp = carePlans.find(p => p.id==planId);
            if(cp){
                showSection('evaluation');
                document.getElementById('patient-select').value = cp.patient.id;
                // Repeupler l'UI des scores
                updateEvalDevices();
                // Attributs : aucun stockage des critères séparés, donc réutilise les scores pour guider
                // (Ici, les champs sont laissés aux valeurs courantes, ou on pourrait stocker tout le détail pour chaque plan dans l'objet "plan" si besoin plus tard !)
                setTimeout(()=>{
                    calculateRisks();
                    // Suggérer visuel pour l'utilisateur de cliquer sur Générer plan de soins pour valider la mise à jour.
                },90);
                // Ajoute l'instruction
                alert("Réalisez d'éventuelles modifications puis cliquez de nouveau sur 'Générer plan de soins' pour enregistrer la mise à jour.");
                // Sauvegarde la mise à jour au clic du bouton
                document.querySelector("#evaluation-section button[onclick*='generateCarePlan']").onclick=function(){
                    generateCarePlan(true, planId);
                    showSection('care-plans');
                };
            }
        }

        // DISPOSITIFS
        function showNewDeviceForm() {
            document.getElementById('new-device-form').reset();
            document.getElementById('new-device-form').classList.remove('hidden');
        }
        function hideNewDeviceForm() {
            document.getElementById('new-device-form').classList.add('hidden');
        }
        function addDevice() {
            const device = {
                patientId: document.getElementById('device-patient').value,
                type: document.getElementById('device-type').value,
                location: document.getElementById('device-location').value,
                insertion: document.getElementById('device-insertion').value,
                notes: document.getElementById('device-notes').value,
                criticality: document.getElementById('device-criticality').value
            };
            devices.push(device);
            updateDevicesList();
            updateEvalDevices();
            hideNewDeviceForm();
        }
        function updateDevicesList() {
            const fullList = document.getElementById('devices-full-list');
            if(fullList) fullList.innerHTML = '';
            devices.forEach(d => {
                const patient = patients.find(p => p.id == d.patientId);
                const className = d.criticality === 'critical' ? 'device-critical' : 'device-ok';
                const li = document.createElement('li');
                li.innerHTML = `<span class="${className}">${patient ? patient.name + ' ' + patient.firstname : 'Inconnu'} - ${d.type} (${d.criticality === 'critical' ? 'À retirer' : 'Bon'})</span>`;
                if(fullList) fullList.appendChild(li.cloneNode(true));
            });
        }
        // Dispositifs du patient dans page évaluation
        function updateEvalDevices() {
            const evalList = document.getElementById('devices-list');
            if(!evalList) return;
            evalList.innerHTML='';
            const pid = document.getElementById('patient-select').value;
            const pats = patients.filter(p=>p.id==pid);
            if(pid==='' || pats.length===0) return;
            const patDevices = devices.filter(d=>d.patientId==pid);
            patDevices.forEach(d=>{
                const className = d.criticality === 'critical' ? 'device-critical' : 'device-ok';
                const li = document.createElement('li');
                li.innerHTML = `${d.type} (${d.criticality==='critical' ? 'À retirer' : 'Bon'}) <span class="${className}">(${d.location || 'non précisée'})</span> `;
                evalList.appendChild(li);
            })
            // Score update :
            calculateRisks();
        }
        // Bouton ajout dispositif dans évaluation
        function addDeviceFromEval() {
            const pid = document.getElementById('patient-select').value;
            if (pid !== "") {
                showSection('devices');
                showNewDeviceForm();
                document.getElementById('device-patient').value = pid;
            } else {
                alert("Veuillez d'abord sélectionner un patient !");
            }
        }

        // ADMIN
        function updateAdminSelects() {
            updatePatientSelects();
            updateCarePlans();
        }
        function deletePatient() {
            if (currentUserEmail !== 'zbawab@cmd.cd') return;
            const selectedId = document.getElementById('admin-patient-select').value;
            if (selectedId === '' || !confirm("Confirmer la suppression du patient ?")) return;
            patients = patients.filter(p => p.id != selectedId);
            devices = devices.filter(d => d.patientId != selectedId);
            carePlans = carePlans.filter(cp => cp.patient.id != selectedId);
            updatePatientList();
            updatePatientSelects();
            updateDevicesList();
            updateCarePlans();
            alert('Patient supprimé');
        }
        function deleteCarePlan() {
            if (currentUserEmail !== 'zbawab@cmd.cd') return;
            const selectedId = document.getElementById('admin-plan-select').value;
            if (selectedId === '' || !confirm("Confirmer la suppression du plan ?")) return;
            carePlans = carePlans.filter(cp => cp.id != selectedId);
            updateCarePlans();
            alert('Plan de soins supprimé');
        }
    </script>
</body>
</html>
