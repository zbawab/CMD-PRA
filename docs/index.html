<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CareRisk - √âvaluation des Risques Patients</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:linear-gradient(132deg,#e7ebf5,#d6f1fb 60%,#e9d9f6 100%); min-height:100vh; color:#333; display:flex; flex-direction:column; align-items:center;}
header { background:#0056b3; color:white; width:100%; text-align:center; padding-top:10px; padding-bottom:7px; display:flex; flex-direction:column; align-items:center; box-shadow:0 4px 8px rgba(70,90,120,0.06); cursor:pointer;}
#cmd-logo { width:90px; margin-bottom:6px; margin-top:6px;}
#user-bar {margin-bottom: 12px; color:#0056b3; font-size:1.1em; font-weight:600; text-align:center;}
h1 { margin:0 0 8px 0; font-size:2.1em; font-weight:bold; letter-spacing:0.5px;}
nav { background-color:#007bff; width:100%; padding:10px 0 10px 0; text-align:center;}
nav button { margin:6px 7px; padding:10px 15px; background-color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold; color:#0056b3; transition:0.2s;}
nav button:hover { background-color:#d6f1fb; color:#0056b3;}
.container { max-width:900px; width:98%; padding:22px 20px; background-color:white; box-shadow:0 4px 14px rgba(40,70,100,0.09); margin:26px 0 26px 0; border-radius:12px;}
.container.home { background:linear-gradient(120deg,#cedbfa 55%,#e6faed 100%); box-shadow:0 4px 40px rgba(70,90,120,0.07); margin-top:28px; margin-bottom:18px;}
.welcome-title { color:#3840b9; font-weight:bold; font-size:2em; margin:0 0 .6em 0;}
.welcome2 { color:#197c80; font-size:1.06em; margin-bottom:.7em; max-width:760px; text-align:justify;}
form { display:flex; flex-direction:column;}
label.eval-critere { margin-bottom:6px; margin-top:12px; font-weight:bold;}
input, select, button, textarea { margin:4px 0 14px 0; padding:10px; font-size:16px; border-radius:5px; border:1px solid #ccc;}
textarea { resize:vertical;}
button { background-color:#28a745; color:white; cursor:pointer; transition:0.2s;}
button[type="button"]:not([onclick]), button.annuler-btn { background-color:#aaa;}
button:hover { background-color:#218838;}
.hidden { display:none;}
.risk-section { margin:28px 0 28px 0; background-color:#f8f9fa; padding:20px 12px 18px 12px; border-radius:11px; box-shadow:0 2px 10px rgba(10,70,110,0.03);}
.risk-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;}
.risk-label { display:inline-block; font-weight:bold; margin-left:8px; padding:2px 11px 2px 11px; border-radius:6px; font-size:1.01em; vertical-align:middle;}
.risk-low { color:#1e8422; background-color:#eaffea;}
.risk-moderate { color:#d35400; background-color:#fff6e6;}
.risk-high { color:#c0392b; background-color:#ffeaea;}
.device-critical { color:#c0392b; font-weight:bold;}
.device-ok { color:#28a745; font-weight:bold;}
.device-alert-block {background:#ffeaea; border-radius:7px; color:#c0392b; margin:8px 0 4px 0; padding: 9px 5px; text-align:center; font-weight:bold;}
.device-foot {font-size:0.97em; color:#7a0815; margin:2px 0 4px 0;}
.plan-historique { font-size:0.97em; margin-top:9px;}
.plan-update-btn { margin-top:8px; background-color:#007bff !important;}
.plan-update-btn:hover { background-color:#0056b3 !important;}
.plan-actions { padding:13px 7px; margin:8px 0 10px 0;}
.plan-actions-title { font-weight:bold; color:#197c80; font-size:1.13em; margin-bottom:7px;}
.plan-actions-list { margin:0; padding-left:24px; color:#225268; font-size:1.01em;}
.patient-meta { font-size:0.89em; color:#888; margin-top:2px; line-height:1.3;}
@media (max-width:690px) { h1 { font-size:1.3em;} .container, .container.home { max-width:99vw; padding:9px 1vw;} #cmd-logo { width:60px; } }
</style>
</head>
<body>
<header onclick="goHome()" title="Retour √† l'accueil">
    <img src="logo-cmd.png" alt="Centre M√©dical Diamant logo" id="cmd-logo">
    <h1>CareRisk - √âvaluation des Risques Patients</h1>
    <div id="user-bar" class="hidden"></div>
</header>
<div id="home" class="container home">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="welcome-title">Bienvenue sur <span style="color:#197c80;">CareRisk</span>&nbsp;!</div>
        <div class="welcome2">
            L‚Äôoutil <b>CareRisk</b> aide les √©quipes infirmi√®res √† √©valuer et suivre les risques patients selon les standards internationaux. C'est est une application d'aide √† la d√©cision qui int√®gre les donn√©es des patients hospitalis√©s pour calculer un score de risque pr√©cis et puis g√©n√©rer de plans de soins personnalis√©s sp√©cifiques √† chaque risque identifi√©. L'outil assure une pr√©vention cibl√©e et un suivi rigoureux des protocoles pour garantir la s√©curit√© et l'optimisation des soins.
        </div>
    </div>
    <ul style="font-size:1.18em;margin:0 0 16px 0;padding:0 0 0 22px;list-style: disc;">
        <li>Connexion rapide avec votre compte personnel CMD</li>
        <li>Gestion des <span style="color:#2a7a32;">patients</span>, <span style="color:#197c80;">dispositifs</span> et <span style="color:#d35400;">risques</span></li>
        <li>Plans de soins g√©n√©r√©s automatiquement selon les scores</li>
    </ul>
    <form id="login-form" onsubmit="login(); return false;" style="margin-top:15px;max-width:330px;">
        <label for="full-name" style="font-weight:bold;">Nom complet</label>
        <input type="text" id="full-name" required placeholder="Votre nom complet">
        <label for="email" style="font-weight:bold;">Compte mail CMD</label>
        <input type="email" id="email" required placeholder="prenom.nom@cmd.cd">
        <label for="service" style="font-weight:bold;">Service</label>
        <select id="service" required>
            <option>-- S√©lectionnez le service --</option>
            <option>M√©decine</option>
            <option>Chirurgie</option>
            <option>Maternit√©</option>
            <option>P√©diatrie</option>
            <option>Soins Intensifs</option>
            <option>N√©onatologie</option>
        </select>
        <button type="submit" style="margin-top: 0.5em;">Se connecter</button>
    </form>
    <div style="margin-top:15px;font-size:0.98em;color:#108;">Contact administrateur¬†: zbawab@cmd.cd</div>
</div>
<nav id="nav" class="hidden">
    <button onclick="showSection('patients')">Liste des Patients</button>
    <button onclick="showSection('evaluation')">√âvaluation</button>
    <button onclick="showSection('care-plans')">Plans de soins</button>
    <button onclick="showSection('devices')">Dispositifs</button>
    <button id="admin-nav-btn" class="hidden" onclick="showSection('admin-controls')">Admin</button>
</nav>
<div id="app" class="container hidden">
    <section id="patients-section">
    <h2>Liste des patients</h2>
    <ul id="patient-list"></ul>
    <button onclick="showNewPatientForm()">Nouveau patient</button>
    <form id="new-patient-form" class="hidden" onsubmit="addPatient(); return false;">
        <label class="eval-critere" for="patient-name">Nom</label>
        <input type="text" id="patient-name" required placeholder="Nom du patient">
        <label class="eval-critere" for="patient-firstname">Pr√©nom</label>
        <input type="text" id="patient-firstname" required placeholder="Pr√©nom du patient">
        <label class="eval-critere" for="patient-age">√Çge</label>
        <input type="number" id="patient-age" required min="0" max="120" placeholder="ex : 65">
        <label class="eval-critere" for="patient-room">Chambre</label>
        <input type="text" id="patient-room" required placeholder="Num√©ro de chambre">
        <label class="eval-critere" for="patient-diagnosis">Diagnostic principal</label>
        <input type="text" id="patient-diagnosis" required placeholder="Diagnostic principal">
        <button type="submit">Ajouter</button>
        <button type="button" class="annuler-btn" onclick="hideNewPatientForm()">Annuler</button>
    </form>
</section>
<section id="evaluation-section" class="hidden">
    <h2>√âvaluation des risques</h2>
    <label class="eval-critere" for="patient-select">S√©lectionnez un patient</label>
    <select id="patient-select" onchange="updateEvalDevices();calculateRisks()"></select>
    <!-- Braden -->
    <div class="risk-section">
        <div class="risk-header">
            <h3 style="margin:0;">Risque d'escarres (√âchelle de Braden)</h3>
        </div>
        <label class="eval-critere">Perception sensorielle</label>
        <select id="braden-sensory" onchange="calculateRisks()">
            <option value="1">Compl√®tement limit√©e (1)</option>
            <option value="2">Tr√®s limit√©e (2)</option>
            <option value="3">L√©g√®rement limit√©e (3)</option>
            <option value="4">Aucune limitation (4)</option>
        </select>
        <label class="eval-critere">Humidit√©</label>
        <select id="braden-humidity" onchange="calculateRisks()">
            <option value="1">Constamment humide (1)</option>
            <option value="2">Tr√®s humide (2)</option>
            <option value="3">Occasionnellement humide (3)</option>
            <option value="4">Rarement humide (4)</option>
        </select>
        <label class="eval-critere">Activit√©</label>
        <select id="braden-activity" onchange="calculateRisks()">
            <option value="1">Alit√© (1)</option>
            <option value="2">En fauteuil (2)</option>
            <option value="3">Marche occasionnellement (3)</option>
            <option value="4">Marche fr√©quemment (4)</option>
        </select>
        <label class="eval-critere">Mobilit√©</label>
        <select id="braden-mobility" onchange="calculateRisks()">
            <option value="1">Compl√®tement immobile (1)</option>
            <option value="2">Tr√®s limit√©e (2)</option>
            <option value="3">L√©g√®rement limit√©e (3)</option>
            <option value="4">Aucune limitation (4)</option>
        </select>
        <label class="eval-critere">Nutrition</label>
        <select id="braden-nutrition" onchange="calculateRisks()">
            <option value="1">Tr√®s pauvre (1)</option>
            <option value="2">Probablement inad√©quate (2)</option>
            <option value="3">Ad√©quate (3)</option>
            <option value="4">Excellente (4)</option>
        </select>
        <label class="eval-critere">Friction et cisaillement</label>
        <select id="braden-friction" onchange="calculateRisks()">
            <option value="1">Probl√®me (1)</option>
            <option value="2">Probl√®me potentiel (2)</option>
            <option value="3">Aucun probl√®me apparent (3)</option>
        </select>
        <p style="margin-bottom:0;">
            Score Braden: <span id="braden-score">0</span>/23
            <span id="braden-risque" class="risk-label"></span>
        </p>
    </div>
    <!-- Morse -->
    <div class="risk-section">
        <div class="risk-header">
            <h3 style="margin:0;">Risque de chutes (√âchelle de Morse)</h3>
        </div>
        <label class="eval-critere">Historique de chutes</label>
        <select id="morse-history" onchange="calculateRisks()">
            <option value="0">Non (0)</option>
            <option value="25">Oui (25)</option>
        </select>
        <label class="eval-critere">Diagnostic secondaire</label>
        <select id="morse-secondary" onchange="calculateRisks()">
            <option value="0">Non (0)</option>
            <option value="15">Oui (15)</option>
        </select>
        <label class="eval-critere">Aide √† la marche</label>
        <select id="morse-aid" onchange="calculateRisks()">
            <option value="0">Aucune/lit/aide soignant (0)</option>
            <option value="15">B√©quilles/canne/d√©ambulateur (15)</option>
            <option value="30">Mobilier (30)</option>
        </select>
        <label class="eval-critere">Th√©rapie IV/acc√®s veineux</label>
        <select id="morse-iv" onchange="calculateRisks()">
            <option value="0">Non (0)</option>
            <option value="20">Oui (20)</option>
        </select>
        <label class="eval-critere">D√©marche</label>
        <select id="morse-gait" onchange="calculateRisks()">
            <option value="0">Normale/lit/fauteuil roulant (0)</option>
            <option value="10">Faible (10)</option>
            <option value="20">D√©marche alt√©r√©e (20)</option>
        </select>
        <label class="eval-critere">√âtat mental</label>
        <select id="morse-mental" onchange="calculateRisks()">
            <option value="0">Orient√© vers ses capacit√©s (0)</option>
            <option value="15">Sur√©value ses capacit√©s (15)</option>
        </select>
        <p style="margin-bottom:0;">
            Score Morse: <span id="morse-score">0</span>/125
            <span id="morse-risque" class="risk-label"></span>
        </p>
    </div>
    <!-- Infection -->
    <div class="risk-section">
        <div class="risk-header">
            <h3 style="margin:0;">Risque d'infection</h3>
            <button type="button" onclick="addDeviceFromEval()">Ajouter un dispositif</button>
        </div>
        <label class="eval-critere">√Çge</label>
        <select id="infection-age" onchange="calculateRisks()">
            <option value="0">&lt; 65 ans (0)</option>
            <option value="1">65-80 ans (1)</option>
            <option value="2">&gt; 80 ans (2)</option>
        </select>
        <label class="eval-critere">Immunosuppression</label>
        <select id="infection-immuno" onchange="calculateRisks()">
            <option value="0">Non (0)</option>
            <option value="2">Oui (2)</option>
        </select>
        <label class="eval-critere">Antibiotiques r√©cents</label>
        <select id="infection-antibiotics" onchange="calculateRisks()">
            <option value="0">Non (0)</option>
            <option value="1">Oui (1)</option>
        </select>
        <label class="eval-critere">Chirurgie r√©cente</label>
        <select id="infection-surgery" onchange="calculateRisks()">
            <option value="0">Non (0)</option>
            <option value="1">Oui (1)</option>
        </select>
        <label class="eval-critere">Comorbidit√©s</label>
        <select id="infection-comorbidities" onchange="calculateRisks()">
            <option value="0">Aucune (0)</option>
            <option value="1">1-2 comorbidit√©s (1)</option>
            <option value="2">3+ comorbidit√©s (2)</option>
        </select>
        <div style="margin-top:12px;">
            <label class="eval-critere" style="font-size:1.02em; font-weight:600;">
                Dispositifs invasifs pour ce patient
            </label>
            <ul id="devices-list"></ul>
        </div>
        <p style="margin-bottom:0;">
            Score dispositifs: <span id="devices-score">0</span>
        </p>
        <p style="margin-bottom:0;">
            Score Infection: <span id="infection-score">0</span>/10
            <span id="infection-risque" class="risk-label"></span>
        </p>
    </div>
    <button onclick="calculateRisks()">Calculer les risques</button>
    <button onclick="generateCarePlan()">G√©n√©rer plan de soins</button>
</section>
<section id="care-plans-section" class="hidden">
    <h2>Plans de soins g√©n√©r√©s</h2>
    <div id="care-plan-output"></div>
   <!-- plus de bouton ici¬†: tout est par patient ! -->
</section>
<section id="devices-section" class="hidden">
    <h2>Gestion des Dispositifs Invasifs</h2>
    <button onclick="showNewDeviceForm()">Nouveau dispositif</button>
    <form id="new-device-form" class="hidden" onsubmit="addDevice(); return false;">
        <label class="eval-critere" for="device-patient">Patient</label>
        <select id="device-patient"></select>
        <label class="eval-critere" for="device-type">Type de dispositif</label>
        <select id="device-type">
            <option>S√©lectionner un type</option>
            <option>Cath√©ter Central</option>
            <option>Cath√©ter P√©riph√©rique</option>
            <option>Cath√©ter ombilical</option>
            <option>Sonde Urinaire</option>
            <option>Intubation Endotrach√©ale</option>
            <option>Ventilation non-invasive</option>
            <option>Drain Thoracique</option>
            <option>Sonde Nasogastrique</option>
            <option>Cath√©ter √âpidural</option>
            <option>Pace-maker Temporaire</option>
            <option>Cath√©ter de Dialyse</option>
            <option>Monitoring invasif</option>
            <option>Autre</option>
        </select>
        <label class="eval-critere" for="device-location">Localisation</label>
        <input type="text" id="device-location" required placeholder="Ex: membre sup√©rieur droit / ombilic">
        <label class="eval-critere" for="device-insertion">Date/Heure d'insertion</label>
        <input type="datetime-local" id="device-insertion" required>
        <label class="eval-critere" for="device-notes">Notes</label>
        <textarea id="device-notes" placeholder="Commentaires..."></textarea>
        <button type="submit">Ajouter</button>
        <button type="button" class="annuler-btn" onclick="hideNewDeviceForm()">Annuler</button>
    </form>
    <ul id="devices-full-list"></ul>
</section>
<section id="admin-controls" class="hidden">
    <h3>Contr√¥les Administrateur</h3>
    <label for="admin-patient-select">S√©lectionnez un patient √† supprimer</label>
    <select id="admin-patient-select"></select>
    <button onclick="deletePatient()">Supprimer patient</button>
    <label for="admin-plan-select">S√©lectionnez un plan √† supprimer</label>
    <select id="admin-plan-select"></select>
    <button onclick="deleteCarePlan()">Supprimer plan de soins</button>
</section>
<script>
const dispositifsRegles = {
  "Cath√©ter Central":      {maxH: 168},
  "Cath√©ter P√©riph√©rique": {maxH: 96},
  "Sonde Urinaire":        {maxH: 360},
  "Cath√©ter ombilical":    {maxH: 144},
  "Intubation Endotrach√©ale": {maxH: 168},
  "Ventilation non-invasive": {maxH: 120},
  "Drain Thoracique":      {maxH: 120},
  "Sonde Nasogastrique":   {maxH: 168},
  "Cath√©ter √âpidural":     {maxH: 96},
  "Pace-maker Temporaire": {maxH: 168},
  "Cath√©ter de Dialyse":   {maxH: 168},
  "Monitoring invasif":    {maxH: 144}
};

function formatDate(dt) {
    if(!dt) return '';
    let date = new Date(dt);
    let d = String(date.getDate()).padStart(2,'0');
    let m = String(date.getMonth()+1).padStart(2,'0');
    let y = date.getFullYear();
    let h = String(date.getHours()).padStart(2,'0');
    let min = String(date.getMinutes()).padStart(2,'0');
    return `${d}/${m}/${y} ${h}:${min}`;
}
function deviceCriticite(type, dt) {
    if(!dt) return "ok";
    const now = new Date();
    const ins = new Date(dt);
    let diffJours = (now - ins)/86400000;
    let h = diffJours*24;
    let maxH = (dispositifsRegles[type] && dispositifsRegles[type].maxH)||144;
    return (h>maxH) ? "critical" : "ok";
}
function deviceDureeText(type, dt) {
    if(!dt) return "";
    const now = new Date(), ins = new Date(dt);
    let h = Math.round((now-ins)/36e5);
    let maxH = (dispositifsRegles[type] && dispositifsRegles[type].maxH)||144;
    return `Dur√©e : ${h}h / ${maxH}h max`;
}

// ----------- Sauvegarde et Chargement Persistance -------------
function saveAll() {
    localStorage.setItem('carePatients', JSON.stringify(patients));
    localStorage.setItem('careDevices', JSON.stringify(devices));
    localStorage.setItem('carePlans', JSON.stringify(carePlans));
}
function loadAll() {
    let p=localStorage.getItem('carePatients'), d=localStorage.getItem('careDevices'), c=localStorage.getItem('carePlans');
    patients = p ? JSON.parse(p) : [];
    devices = d ? JSON.parse(d) : [];
    carePlans = c ? JSON.parse(c) : [];
}

// ------------ LOGIQUE APPLI -------------
let patients = [];
let devices = [];
let carePlans = [];
let currentUserEmail = '', currentUserFullName = '', currentUserService = '', currentSection = 'patients';

// ------------ NAVIGATION & UTILISATEUR ------------
function goHome() { location.reload(); }
function login() {
    const email = document.getElementById('email').value;
    const fullName = document.getElementById('full-name').value;
    const service = document.getElementById('service').value;
    currentUserEmail = email;
    currentUserFullName = fullName;
    currentUserService = service;
    document.getElementById('home').classList.add('hidden');
    document.getElementById('nav').classList.remove('hidden');
    document.getElementById('app').classList.remove('hidden');
    setUserBar();
    if (email === 'zbawab@cmd.cd') {
        document.getElementById('admin-controls').classList.remove('hidden');
        document.getElementById('admin-nav-btn').classList.remove('hidden');
    }
    loadData();
    showSection('patients');
}
function setUserBar() {
    let txt = '';
    if(currentUserFullName)
        txt = 'Connect√© : <span style="color:#197c80;font-weight:bold;">'+currentUserFullName+'</span>';
    if(currentUserService && currentUserService!=="-- S√©lectionnez le service --")
        txt += ' ‚Äî¬†Service : <span style="color:#d35400;">'+currentUserService+'</span>';
    document.getElementById('user-bar').innerHTML = txt;
    document.getElementById('user-bar').classList.remove('hidden');
}
function showSection(section) {
    let sections = ['patients-section','evaluation-section','care-plans-section','devices-section','admin-controls'];
    sections.forEach(id => {
        let el = document.getElementById(id);
        if (el) el.classList.add('hidden');
    });
    if (section === 'admin-controls') document.getElementById('admin-controls').classList.remove('hidden');
    else document.getElementById(`${section}-section`).classList.remove('hidden');
    currentSection = section;
    updateAdminSelects();
    if(section=="evaluation") updateEvalDevices();
}

// ------------ DONN√âES PATIENTS & CO -------------
function loadData() {
    loadAll();
    if (patients.length === 0) {
        patients = [
          { id: 0, name: 'Doe', firstname: 'John', age: 50, room: '101', diagnosis: 'Exemple', createdAt: formatDate(new Date()), createdBy: 'Systeme'}
        ];
    }
    updatePatientList();
    updatePatientSelects();
    updateDevicesList();
}
function showNewPatientForm() { document.getElementById('new-patient-form').reset(); document.getElementById('new-patient-form').classList.remove('hidden'); }
function hideNewPatientForm() { document.getElementById('new-patient-form').classList.add('hidden'); }
function addPatient() {
    const patient = {
        id: patients.length>0 ? Math.max(...patients.map(p=>p.id))+1 : 0,
        name: document.getElementById('patient-name').value,
        firstname: document.getElementById('patient-firstname').value,
        age: document.getElementById('patient-age').value,
        room: document.getElementById('patient-room').value,
        diagnosis: document.getElementById('patient-diagnosis').value,
        createdAt: formatDate(new Date()),
        createdBy: currentUserFullName
    };
    patients.push(patient);
    updatePatientList();
    updatePatientSelects();
    hideNewPatientForm();
    saveAll();
}
function updatePatientList() {
    const list = document.getElementById('patient-list'); list.innerHTML = '';
    patients.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name} ${p.firstname} - √Çge: ${p.age} - Chambre: ${p.room}`;
        const meta = document.createElement('div');
        meta.className = "patient-meta";
        meta.textContent = `Ajout√© le ${p.createdAt ?? ''} par ${p.createdBy ?? ''}`;
        li.appendChild(meta); list.appendChild(li);
    });
}
function updatePatientSelects() {
    const selects = [
        document.getElementById('patient-select'),
        document.getElementById('device-patient'),
        document.getElementById('admin-patient-select')
    ];
    selects.forEach(select => {
        if (select) {
            select.innerHTML = '<option value="">S√©lectionner un patient...</option>';
            patients.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id; option.textContent = `${p.name} ${p.firstname}`;
                select.appendChild(option);
            });
        }
    });
}

function getRiskLabel(score, cat) {
    if(cat=="braden") {
        if(score<=12)   return {text:'Risque √©lev√©', class:'risk-high'};
        if(score<=16)   return {text:'Risque mod√©r√©', class:'risk-moderate'};
        return {text:'Risque faible', class:'risk-low'};
    } else if(cat=="morse") {
        if(score>=51)   return {text:'Risque √©lev√©', class:'risk-high'};
        if(score>=25)   return {text:'Risque mod√©r√©', class:'risk-moderate'};
        return {text:'Risque faible', class:'risk-low'};
    } else if(cat=="infection") {
        if(score>=7)    return {text:'Risque √©lev√©', class:'risk-high'};
        if(score>=4)    return {text:'Risque mod√©r√©', class:'risk-moderate'};
        return {text:'Risque faible', class:'risk-low'};
    }
    return {text:'',class:''};
}
function getCareActions(risques) {
    let act = [];
    // Braden
    if(risques.braden<=12) {
        act = act.concat([
            "Changement de position toutes les 2¬†heures.",
            "Coussin ou matelas anti-escarres (√† adapter √† la morphologie).",
            "Surveillance cutan√©e syst√©matique : rougeurs, phlyct√®nes, chaleur, induration.",
            "Hygi√®ne de la peau douce, s√©cher d√©licatement ; soins locaux pr√©ventifs adapt√©s.",
            "Hydratation cutan√©e quotidienne, √©viter les massages sur peaux l√©s√©es.",
            "Apports nutritionnels accrus si prescription ; surveillance bilan hydrique.",
            "Limiter l‚Äôhumidit√© corporelle : changes fr√©quents, soins d‚Äôincontinence.",
            "Education et implication famille, transmissions cibl√©es au staff."
        ]);
    } else if(risques.braden<=16) {
        act = act.concat([
            "Mobilisation minimum toutes les 3 heures.",
            "V√©rifier l‚Äôutilisation correcte des appuis (t√™te/lombes/talons).",
            "Surveillance cutan√©e √† chaque tour.",
            "Rappels r√©guliers au patient/famille.",
            "Installer la sonnette √† port√©e et v√©rifier la position du lit."
        ]);
    } else {
        act = act.concat([
            "V√©rifier r√©guli√®rement l‚Äôint√©grit√© cutan√©e,",
            "Pr√©venir l'immobilisation prolong√©e.",
            "Soins d‚Äôhygi√®ne corporelle rigoureux.",
        ]);
    }
    // Morse
    if(risques.morse>=51) {
        act = act.concat([
            "Installer barri√®res de s√©curit√© adapt√©es.",
            "Placer la sonnette et les effets personnels du patient √† port√©e de main.",
            "Informer le patient et la famille des risques, sensibiliser.",
            "Signaler le risque sur la porte ou le lit.",
            "Surveiller la vigilance psychique du patient.",
            "Pr√©venir l'√©quipe lors des transferts.",
            "Placement d‚Äôun chemin lumineux pour la nuit.",
            "Limiter les obstacles et accessoires inutiles pr√®s du lit.",
            "Conseiller l‚Äôutilisation de chaussures antid√©rapantes.",
        ]);
    } else if(risques.morse>=25) {
        act = act.concat([
            "Informer/famille sur pr√©vention des chutes.",
            "Ranger l‚Äôespace, obstacles hors du chemin.",
            "Favoriser la pr√©sence ou l‚Äôappel d‚Äôun soignant pour le lever.",
            "Installer des aides techniques si besoin."
        ]);
    } else {
        act = act.concat([
            "Respecter la politique de pr√©vention des chutes : sols propres, lumi√®re adapt√©e, sonnette en place.",
            "Informer le patient √† la surveillance familiale.",
        ]);
    }
    // Infection
    if(risques.infection>=7) {
        act = act.concat([
            "Hygi√®ne stricte des mains avant/apr√®s chaque soin.",
            "Surveillance quotidienne des abords, pansements et dispositifs.",
            "D√©sinfection rigoureuse de tout le mat√©riel, respect stricte de l‚Äôasepsie.",
            "Changer (ou retirer) les dispositifs d√©passant la dur√©e maximale recommand√©e.",
            "Suivi temp√©rature, vigilance signes locaux¬†: chaleur, rougeur, √©coulement, ≈ìd√®me.",
            "Transmission des informations infection via le dossier de soins.",
            "√âducation du patient/famille‚ÄØ: lavage des mains, port du masque, √©viter contacts ext√©rieurs.",
            "V√©rification prescription m√©dicale (antibiotiques, pr√©l√®vements).",
            "Pr√©voir isolement si suspicion ou confirmation d‚Äôinfection s√©v√®re.",
        ]);
    } else if(risques.infection>=4) {
        act = act.concat([
            "Respect scrupuleux du lavage des mains (patients, famille, soignants).",
            "Soins locaux du dispositif selon protocole : nettoyage, asepsie.",
            "V√©rification r√©guli√®re des dates d‚Äôinsertion, signalement des anciens dispositifs.",
            "Entretien quotidien de la chambre‚ÄØ: surfaces d√©sinfect√©es.",
            "Prise en charge nutritionnelle pour pr√©venir la d√©nutrition (facteur de risque).",
            "Surveillance des param√®tres vitaux."
        ]);
    } else {
        act = act.concat([
            "Informer et rappeler √† tous les intervenants de r√©aliser le lavage des mains.",
            "Hygi√®ne corporelle du patient soign√©e quotidiennement.",
            "Nettoyage du mat√©riel et des surfaces √† chaque soin.",
            "Soins pr√©ventifs des dispositifs pr√©sents.",
            "Pr√©paration des pr√©l√®vements ou protocoles adapt√©s si n√©cessaire.",
            "Education du patient et de la famille sur les r√®gles d‚Äôasepsie.",
        ]);
    }
    return act;
}
function calculateRisks() {
    const braden = parseInt(document.getElementById('braden-sensory').value)
        + parseInt(document.getElementById('braden-humidity').value)
        + parseInt(document.getElementById('braden-activity').value)
        + parseInt(document.getElementById('braden-mobility').value)
        + parseInt(document.getElementById('braden-nutrition').value)
        + parseInt(document.getElementById('braden-friction').value);
    document.getElementById('braden-score').textContent = braden;
    let bradenLab = getRiskLabel(braden,"braden");
    let bradenSpan = document.getElementById('braden-risque');
    bradenSpan.textContent = bradenLab.text;
    bradenSpan.className = "risk-label "+bradenLab.class;
    const morse = parseInt(document.getElementById('morse-history').value)
        + parseInt(document.getElementById('morse-secondary').value)
        + parseInt(document.getElementById('morse-aid').value)
        + parseInt(document.getElementById('morse-iv').value)
        + parseInt(document.getElementById('morse-gait').value)
        + parseInt(document.getElementById('morse-mental').value);
    document.getElementById('morse-score').textContent = morse;
    let morseLab = getRiskLabel(morse,"morse");
    let morseSpan = document.getElementById('morse-risque');
    morseSpan.textContent = morseLab.text;
    morseSpan.className = "risk-label "+morseLab.class;
    const pid = document.getElementById('patient-select').value;
    const patientDevices = devices.filter(d => d.patientId == pid);
    const devicesScore = patientDevices.reduce((sum, d) => sum + ((d.criticite||"ok") === 'critical' ? 2 : 1), 0);
    document.getElementById('devices-score').textContent = devicesScore;
    const infection = parseInt(document.getElementById('infection-age').value)
        + parseInt(document.getElementById('infection-immuno').value)
        + parseInt(document.getElementById('infection-antibiotics').value)
        + parseInt(document.getElementById('infection-surgery').value)
        + parseInt(document.getElementById('infection-comorbidities').value)
        + devicesScore;
    const infScore = Math.min(infection, 10);
    document.getElementById('infection-score').textContent = infScore;
    let infLab = getRiskLabel(infScore,"infection");
    let infSpan = document.getElementById('infection-risque');
    infSpan.textContent = infLab.text;
    infSpan.className = "risk-label "+infLab.class;
}

// ------------ DEVICES
function showNewDeviceForm() {
    document.getElementById('new-device-form').reset();
    document.getElementById('new-device-form').classList.remove('hidden');
}
function hideNewDeviceForm() {
    document.getElementById('new-device-form').classList.add('hidden');
}
function addDevice() {
    const deviceInputPatientId = document.getElementById('device-patient').value;
    const type = document.getElementById('device-type').value;
    const location = document.getElementById('device-location').value;
    const insertion = document.getElementById('device-insertion').value;
    const notes = document.getElementById('device-notes').value;
    const criticite = deviceCriticite(type, insertion);
    devices.push({
        patientId: deviceInputPatientId,
        type, location, insertion, notes, criticite
    });
    updateDevicesList();
    hideNewDeviceForm();
    saveAll();
    if(currentSection==="devices") {
        showSection('evaluation');
        document.getElementById('patient-select').value = deviceInputPatientId;
        updateEvalDevices(); calculateRisks();
    } else if(currentSection==="evaluation") {
        updateEvalDevices(); calculateRisks();
    }
}
function updateDevicesList() {
    const fullList = document.getElementById('devices-full-list');
    if(fullList) fullList.innerHTML = '';
    devices.forEach(d => {
        const patient = patients.find(p => p.id == d.patientId);
        const className = (d.criticite === 'critical' ? 'device-critical' : 'device-ok');
        const li = document.createElement('li');
        let foot = deviceDureeText(d.type, d.insertion);
        li.innerHTML = `<span class="${className}">${patient ? patient.name + ' ' + patient.firstname : 'Inconnu'} - ${d.type} (${d.criticite === 'critical' ? '√Ä retirer' : 'Bon'})<br><span style="font-size:0.93em;color:#bbb;">Initi√© le ${formatDate(d.insertion)}</span></span>` +
            (d.criticite==="critical" ? `<div class="device-alert-block">URGENT - √Ä retirer</div>` : '' )
            + `<div class="device-foot">${foot}</div>`;
        if(fullList) fullList.appendChild(li.cloneNode(true));
    });
}
function updateEvalDevices() {
    const evalList = document.getElementById('devices-list');
    if(!evalList) return;
    evalList.innerHTML='';
    const pid = document.getElementById('patient-select').value;
    const pats = patients.filter(p=>p.id==pid);
    if(pid==='' || pats.length===0) return;
    const patDevices = devices.filter(d=>d.patientId==pid);
    patDevices.forEach(d=>{
        const className = (d.criticite === 'critical' ? 'device-critical' : 'device-ok');
        let foot = deviceDureeText(d.type, d.insertion);
        const li = document.createElement('li');
        li.innerHTML = `${d.type} (<span class="${className}">${d.criticite==='critical' ? '√Ä retirer' : 'Bon'}</span>) <span style="color:#888;font-size:.92em">depuis ${formatDate(d.insertion)}</span>`
          + (d.criticite==="critical" ? `<div class="device-alert-block">URGENT - √Ä retirer</div>` : '')
          + `<div class="device-foot">${foot}</div>`;
        evalList.appendChild(li);
    });
    calculateRisks();
}
function addDeviceFromEval() {
    const pid = document.getElementById('patient-select').value;
    if (pid !== "") {
        showSection('devices');
        showNewDeviceForm();
        document.getElementById('device-patient').value = pid;
    } else {
        alert("Veuillez d'abord s√©lectionner un patient !");
    }
}

// ------------ PLANS DE SOINS ----------------
function generateCarePlan(isUpdate = false, updatePlanId=null) {
    const selectedPatientId = document.getElementById('patient-select').value;
    if (selectedPatientId === '' || selectedPatientId=="S√©lectionner un patient...") {
        alert("S√©lectionnez un patient !");
        return;
    }
    const patient = patients.find(p => p.id == selectedPatientId);
    const risques = {
        braden: parseInt(document.getElementById('braden-score').textContent),
        morse: parseInt(document.getElementById('morse-score').textContent),
        infection: parseInt(document.getElementById('infection-score').textContent)
    };
    let now = formatDate(new Date());
    let by = currentUserFullName;
    if(isUpdate && updatePlanId!=null){
        let plan = carePlans.find(p=>p.id==updatePlanId);
        if(plan){
            if(!plan.history) plan.history=[];
            plan.history.push({
                date: now,
                by: by,
                risques: plan.risques,
                actions: plan.actions
            });
            plan.risques = risques;
            plan.lastUpdate = now;
            plan.lastUpdateBy = by;
            plan.actions = getCareActions(risques);
        }
    } else {
        const plan = {
            id: carePlans.length>0 ? Math.max(...carePlans.map(p=>p.id))+1 : 0,
            patient: patient,
            risques: risques,
            actions: getCareActions(risques),
            createdAt: now,
            createdBy: by,
            history: [],
            lastUpdate: now,
            lastUpdateBy: by
        };
        carePlans.push(plan);
    }
    updateCarePlans();
    document.getElementById('download-plan').classList.remove('hidden');
    saveAll();
    setTimeout(()=>{ alert("Plan de soins g√©n√©r√©¬†! Veuillez v√©rifier dans le volet 'Plans de soins'."); },200);
}
function updateCarePlans() {
    const output = document.getElementById('care-plan-output');
    output.innerHTML = '';
    // Groupe les plans par patient
    const patientsWithPlans = {};
    carePlans.forEach(cp => {
        if(!patientsWithPlans[cp.patient.id]) patientsWithPlans[cp.patient.id] = [];
        patientsWithPlans[cp.patient.id].push(cp);
    });
    Object.keys(patientsWithPlans).forEach(pid => {
        const plans = patientsWithPlans[pid];
        const pat = plans[0].patient;
        const patientDiv = document.createElement('div');
        patientDiv.style.border = "1px solid #cdf";
        patientDiv.style.margin = "18px 0";
        patientDiv.style.borderRadius="12px";
        patientDiv.style.background="#f4faff";
        patientDiv.style.boxShadow="0 2px 8px #cbeafc40";
        patientDiv.innerHTML = `<h3 style="color:#005e87;padding:.3em 0 .3em 1em">üßë‚Äç‚öïÔ∏è ${pat.name} ${pat.firstname}</h3>`;
        // --- Affiche CHAQUE plan de ce patient ---
        plans.forEach(cp => {
            let bradenLab = getRiskLabel(cp.risques.braden,"braden");
            let morseLab  = getRiskLabel(cp.risques.morse,"morse");
            let infLab    = getRiskLabel(cp.risques.infection,"infection");
            const div = document.createElement('div');
            div.style.marginLeft = "18px";
            div.style.marginRight="8px";
            div.style.marginBottom="1.5em";
            div.innerHTML = `
                <p><b>Plan g√©n√©r√© le ${cp.createdAt} par ${cp.createdBy}</b> 
                <span style="float:right;font-size:0.94em;color:#444">Derni√®re maj. ${cp.lastUpdate||cp.createdAt}</span></p>
                <ul style="margin-left:1.5em;">
                  <li>Escarres: <span class="risk-label ${bradenLab.class}">${bradenLab.text}</span> (Braden ${cp.risques.braden})</li>
                  <li>Chutes: <span class="risk-label ${morseLab.class}">${morseLab.text}</span> (Morse ${cp.risques.morse})</li>
                  <li>Infection: <span class="risk-label ${infLab.class}">${infLab.text}</span> (Infection ${cp.risques.infection})</li>
                </ul>
                <div class="plan-actions"><div class="plan-actions-title">Actions recommand√©es :</div>
                <ul class="plan-actions-list">
                    ${(cp.actions||[]).map(act=>`<li>${act}</li>`).join('')}
                </ul></div>
                <button onclick="downloadCarePlanSingle(${cp.id})" style="margin:6px 0 0 1.3em;padding:8px 15px;background:#0a9a46;">T√©l√©charger ce plan de soins</button>
                <div class="plan-historique" style="margin-top:8px;">
                <b>Historique de mises √† jour :</b>
                ${(cp.history && cp.history.length>0) ? cp.history.map(h => 
                    `<div class="plan-historique-entry">Modifi√© le <b>${h.date}</b> par <i>${h.by}</i></div>
                    <ul>${(h.actions || []).map(a=>`<li>${a}</li>`).join('')}</ul>`).join('') : '<div>Aucune mise √† jour.</div>'}
                </div>`;
            patientDiv.appendChild(div);    
        });
        output.appendChild(patientDiv);
    });

    // Mise √† jour du select admin
    const planSelect = document.getElementById('admin-plan-select');
    if(planSelect){
        planSelect.innerHTML = '<option value="">S√©lectionner un plan...</option>';
        carePlans.forEach(cp => {
            const option = document.createElement('option');
            option.value = cp.id;
            option.textContent = `Plan pour ${cp.patient.name} ${cp.patient.firstname}`;
            planSelect.appendChild(option);
        });
    }
}
function updatePlanDialog(planId) {
    const cp = carePlans.find(p => p.id==planId);
    if(cp){
        showSection('evaluation');
        document.getElementById('patient-select').value = cp.patient.id;
        updateEvalDevices();
        setTimeout(()=>{ calculateRisks(); },100);

        alert("R√©alisez d'√©ventuelles modifications puis cliquez sur 'G√©n√©rer plan de soins' pour enregistrer la mise √† jour.");

        // Remet d'abord le handler d'origine
        const genBtn = document.querySelector("#evaluation-section button[onclick*='generateCarePlan']");
        if(genBtn) {
            genBtn.onclick = null;
            genBtn.addEventListener('click', function handler() {
                generateCarePlan(true, planId);
                // Sauve imm√©diatement apr√®s modif/m√†j
                saveAll();
                alert("Plan de soins mis √† jour !");
                showSection('care-plans');
                // Une seule ex√©cution !
                genBtn.removeEventListener('click', handler);
                // Apr√®s mise √† jour, remet le 'onclick' standard pour permettre la cr√©ation d'un nouveau plan normal
                genBtn.setAttribute('onclick', 'generateCarePlan()');
            }, { once: true });
        }
    }
}
function downloadCarePlan() {
    const content = carePlans.map(cp => 
        `Plan pour ${cp.patient.name}: Scores - Braden: ${cp.risques.braden}, Morse: ${cp.risques.morse}, Infection: ${cp.risques.infection}; Actions: ${cp.actions.join('; ')}`
        ).join('\n');
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'plans_de_soins.txt';
    a.click();
    URL.revokeObjectURL(url);
}
function downloadCarePlanSingle(planId) {
    const cp = carePlans.find(p => p.id == planId);
    if(!cp) return alert("Plan non trouv√© !");
    // Format texte lisible :
    let txt = 
`Plan de soins pour : ${cp.patient.name} ${cp.patient.firstname}
√Çge : ${cp.patient.age}   Chambre : ${cp.patient.room}
G√©n√©r√© le ${cp.createdAt} par ${cp.createdBy}
Mise √† jour le : ${cp.lastUpdate||cp.createdAt}

--- Risques √©valu√©s ---
- Escarres (Braden) : ${cp.risques.braden} - ${getRiskLabel(cp.risques.braden,"braden").text}
- Chutes (Morse) : ${cp.risques.morse} - ${getRiskLabel(cp.risques.morse,"morse").text}
- Infection : ${cp.risques.infection} - ${getRiskLabel(cp.risques.infection,"infection").text}

--- Actions de soins recommand√©es ---
${(cp.actions||[]).map((a,i)=>`${i+1}. ${a}`).join('\n')}

${(cp.history && cp.history.length>0)? 
`--- Historique modifications ---\n${
    cp.history.map(h=>`MAJ du ${h.date} par ${h.by}\n${(h.actions||[]).map((a,i)=>`- ${a}`).join('\n')}\n`).join('')}`
    :""
}
`;

    // G√©n√®re et t√©l√©charge le fichier texte
    const blob = new Blob([txt], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `plan_soins_${cp.patient.name}_${cp.patient.firstname}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}
// ---------- ADMIN -----------------
function updateAdminSelects() { updatePatientSelects(); updateCarePlans(); }
function deletePatient() {
    if (currentUserEmail !== 'zbawab@cmd.cd') return;
    const selectedId = document.getElementById('admin-patient-select').value;
    if (selectedId === '' || !confirm("Confirmer la suppression‚ÄØdu patient ?")) return;
    patients = patients.filter(p => p.id != selectedId);
    devices = devices.filter(d => d.patientId != selectedId);
    carePlans = carePlans.filter(cp => cp.patient.id != selectedId);
    updatePatientList(); updatePatientSelects(); updateDevicesList(); updateCarePlans();
    saveAll();
    alert('Patient supprim√©');
}
function deleteCarePlan() {
    if (currentUserEmail !== 'zbawab@cmd.cd') return;
    const selectedId = document.getElementById('admin-plan-select').value;
    if (selectedId === '' || !confirm("Confirmer la suppression du plan‚ÄØ?")) return;
    carePlans = carePlans.filter(cp => cp.id != selectedId);
    updateCarePlans(); saveAll(); alert('Plan de soins supprim√©');
}
</script>
</body>
</html>
