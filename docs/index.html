<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareRisk - Évaluation des Risques Patients</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5D5CDE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CareRisk">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#F8FAFC'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
<form id="loginForm" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-5 mb-6 border border-gray-200 max-w-xl mx-auto">
    <h2 class="text-lg font-semibold mb-4 text-primary">Connexion sécurisée CMD</h2>
    <div class="mb-4">
        <label class="block mb-1 text-gray-700 dark:text-gray-300">Nom complet</label>
        <input type="text" id="fullname" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="Prénom Nom">
    </div>
    <div class="mb-4">
        <label class="block mb-1 text-gray-700 dark:text-gray-300">Compte mail CMD</label>
        <input type="email" id="email" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700" placeholder="ex: nom@cmd.cd">
    </div>
    <div class="mb-4">
        <label class="block mb-1 text-gray-700 dark:text-gray-300">Service</label>
        <select id="service" required class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
            <option value="">-- Sélectionnez le service --</option>
            <option value="medecine">Médecine</option>
            <option value="chirurgie">Chirurgie</option>
            <option value="maternite">Maternité</option>
            <option value="pediatrie">Pédiatrie</option>
            <option value="soins-intensifs">Soins Intensifs</option>
        </select>
    </div>
    <button type="submit" class="bg-primary px-5 py-2 rounded-lg text-white font-bold w-full">Se connecter</button>
</form>

<div class="app-description bg-white dark:bg-gray-800 rounded-lg shadow-sm p-5 mt-4 mb-6 border border-primary max-w-3xl mx-auto">
      Carerisk transforme la sécurité des patients. Notre application centralise et structure la gestion des risques cliniques pour tous les patients hospitalisés.
      En exigeant une connexion sécurisée via le compte CMD et en limitant le partage des rapports aux membres du même service,
      Carerisk assure à la fois <strong>la collaboration ciblée des équipes</strong> et <strong>la confidentialité stricte des données</strong>.<br>
      <b>Contact administrateur :</b> zbawab@cmd.cd
</div>
</div>
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="app-description bg-white dark:bg-gray-800 rounded-lg shadow-sm p-5 mt-4 mb-6 border border-primary">
  Carerisk transforme la sécurité des patients. Notre application centralise et structure la gestion des risques cliniques pour tous les patients hospitalisés.
  En exigeant une connexion sécurisée via le compte CMD et en limitant le partage des rapports aux membres du même service,
  Carerisk assure à la fois <strong>la collaboration ciblée des équipes</strong> et <strong>la confidentialité stricte des données</strong>.<br>
  <b>Contact administrateur :</b> zbawab@cmd.cd
        <header class="mb-8">
            <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <div class="flex items-center space-x-3">
                    <div class="bg-primary text-white p-3 rounded-lg">
                        <i class="fas fa-heartbeat text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">CareRisk Pro</h1>
                        <p class="text-gray-600 dark:text-gray-300">Évaluation complète des risques patients</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="flex items-center space-x-4">
                        <div>
                            <label class="block text-sm text-gray-500 dark:text-gray-400">Service</label>
                            <select id="service-select" class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-base bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="medecine">Médecine</option>
                                <option value="chirurgie">Chirurgie</option>
                                <option value="maternite">Maternité</option>
                                <option value="pediatrie">Pédiatrie</option>
                                <option value="soins-intensifs">Soins Intensifs</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-500 dark:text-gray-400">Infirmière</label>
                            <input type="text" id="nurse-name" value="Sarah Martin" class="border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-base bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-medium">
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6">
            <nav class="flex space-x-1 bg-white dark:bg-gray-800 rounded-lg p-1 shadow-sm">
                <button onclick="showTab('patients')" id="tab-patients" class="tab-button active flex-1 py-3 px-4 text-center rounded-md font-medium transition-colors">
                    <i class="fas fa-users mr-2"></i>Patients
                </button>
                <button onclick="showTab('evaluation')" id="tab-evaluation" class="tab-button flex-1 py-3 px-4 text-center rounded-md font-medium transition-colors">
                    <i class="fas fa-clipboard-check mr-2"></i>Évaluation
                </button>
                <button onclick="showTab('plans')" id="tab-plans" class="tab-button flex-1 py-3 px-4 text-center rounded-md font-medium transition-colors">
                    <i class="fas fa-file-medical mr-2"></i>Plans de soins
                </button>
                <button onclick="showTab('devices')" id="tab-devices" class="tab-button flex-1 py-3 px-4 text-center rounded-md font-medium transition-colors">
                    <i class="fas fa-procedures mr-2"></i>Dispositifs
                </button>
            </nav>
        </div>

        <!-- Patients Tab -->
        <div id="patients-tab" class="tab-content">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Liste des patients</h2>
                        <button onclick="showAddPatientModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Nouveau patient
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="patients-list" class="space-y-4">
                        <!-- Patients will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Evaluation Tab -->
        <div id="evaluation-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Évaluation des risques</h2>
                    <p class="text-gray-600 dark:text-gray-300 mt-1">Sélectionnez un patient pour commencer l'évaluation</p>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Patient</label>
                        <select id="patient-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                            <option value="">Sélectionner un patient...</option>
                        </select>
                    </div>

                    <div id="evaluation-form" class="hidden space-y-8">
                        <!-- Risque d'escarres - Échelle de Braden -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-bed text-red-500 mr-2"></i>Risque d'escarres (Échelle de Braden)
                            </h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Perception sensorielle</label>
                                    <select name="braden-sensation" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="1">Complètement limitée (1)</option>
                                        <option value="2">Très limitée (2)</option>
                                        <option value="3">Légèrement limitée (3)</option>
                                        <option value="4">Aucune limitation (4)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Humidité</label>
                                    <select name="braden-moisture" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="1">Constamment humide (1)</option>
                                        <option value="2">Très humide (2)</option>
                                        <option value="3">Occasionnellement humide (3)</option>
                                        <option value="4">Rarement humide (4)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Activité</label>
                                    <select name="braden-activity" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="1">Alité (1)</option>
                                        <option value="2">En fauteuil (2)</option>
                                        <option value="3">Marche occasionnellement (3)</option>
                                        <option value="4">Marche fréquemment (4)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mobilité</label>
                                    <select name="braden-mobility" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="1">Complètement immobile (1)</option>
                                        <option value="2">Très limitée (2)</option>
                                        <option value="3">Légèrement limitée (3)</option>
                                        <option value="4">Aucune limitation (4)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nutrition</label>
                                    <select name="braden-nutrition" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="1">Très pauvre (1)</option>
                                        <option value="2">Probablement inadéquate (2)</option>
                                        <option value="3">Adéquate (3)</option>
                                        <option value="4">Excellente (4)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Friction et cisaillement</label>
                                    <select name="braden-friction" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="1">Problème (1)</option>
                                        <option value="2">Problème potentiel (2)</option>
                                        <option value="3">Aucun problème apparent (3)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Score Braden: <span id="braden-score" class="font-bold">0</span>/23</p>
                                <p class="text-sm" id="braden-risk"></p>
                            </div>
                        </div>

                        <!-- Risque de chutes - Échelle de Morse -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Risque de chutes (Échelle de Morse)
                            </h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Historique de chutes</label>
                                    <select name="morse-history" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Non (0)</option>
                                        <option value="25">Oui (25)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Diagnostic secondaire</label>
                                    <select name="morse-diagnosis" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Non (0)</option>
                                        <option value="15">Oui (15)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Aide à la marche</label>
                                    <select name="morse-aid" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Aucune/lit/aide soignant (0)</option>
                                        <option value="15">Béquilles/canne/déambulateur (15)</option>
                                        <option value="30">Mobilier (30)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Thérapie IV/accès veineux</label>
                                    <select name="morse-iv" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Non (0)</option>
                                        <option value="20">Oui (20)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Démarche</label>
                                    <select name="morse-gait" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Normale/lit/fauteuil roulant (0)</option>
                                        <option value="10">Faible (10)</option>
                                        <option value="20">Démarche altérée (20)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">État mental</label>
                                    <select name="morse-mental" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Orienté vers ses capacités (0)</option>
                                        <option value="15">Surévalue ses capacités (15)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Score Morse: <span id="morse-score" class="font-bold">0</span>/125</p>
                                <p class="text-sm" id="morse-risk"></p>
                            </div>
                        </div>

                        <!-- Risque d'infection avec dispositifs invasifs détaillés -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-virus text-green-500 mr-2"></i>Risque d'infection
                            </h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Âge</label>
                                    <select name="infection-age" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">< 65 ans (0)</option>
                                        <option value="1">65-80 ans (1)</option>
                                        <option value="2">> 80 ans (2)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Immunosuppression</label>
                                    <select name="infection-immune" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Non (0)</option>
                                        <option value="2">Oui (2)</option>
                                    </select>
                                </div>
                                
                                <!-- Section dispositifs invasifs détaillée -->
                                <div class="md:col-span-2">
                                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                <i class="fas fa-procedures mr-2"></i>Dispositifs invasifs
                                            </label>
                                            <button type="button" onclick="showAddDeviceModal()" class="bg-primary text-white px-3 py-1 rounded text-sm hover:bg-primary/90 transition-colors">
                                                <i class="fas fa-plus mr-1"></i>Ajouter
                                            </button>
                                        </div>
                                        <div id="invasive-devices-list" class="space-y-2 min-h-[60px]">
                                            <p class="text-gray-500 dark:text-gray-400 text-sm italic">Aucun dispositif invasif enregistré</p>
                                        </div>
                                        <div class="mt-3 p-2 bg-gray-50 dark:bg-gray-700 rounded">
                                            <p class="text-sm text-gray-600 dark:text-gray-300">Score dispositifs: <span id="devices-score" class="font-bold">0</span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Antibiotiques récents</label>
                                    <select name="infection-antibiotics" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Non (0)</option>
                                        <option value="1">Oui (1)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chirurgie récente</label>
                                    <select name="infection-surgery" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Non (0)</option>
                                        <option value="1">Oui (1)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Comorbidités</label>
                                    <select name="infection-comorbid" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                                        <option value="0">Aucune (0)</option>
                                        <option value="1">1-2 comorbidités (1)</option>
                                        <option value="2">3+ comorbidités (2)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <p class="text-sm text-gray-600 dark:text-gray-300">Score infection: <span id="infection-score" class="font-bold">0</span>/10</p>
                                <p class="text-sm" id="infection-risk"></p>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4">
                            <button onclick="calculateRisks()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                                <i class="fas fa-calculator mr-2"></i>Calculer les risques
                            </button>
                            <button onclick="generateCarePlan()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                <i class="fas fa-file-medical mr-2"></i>Générer plan de soins
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plans Tab -->
        <div id="plans-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Plans de soins générés</h2>
                    <p class="text-gray-600 dark:text-gray-300 mt-1">Plans de soins personnalisés basés sur l'évaluation des risques</p>
                </div>
                <div class="p-6">
                    <div id="care-plans-list" class="space-y-6">
                        <p class="text-gray-500 dark:text-gray-400 text-center py-8">Aucun plan de soins généré. Effectuez d'abord une évaluation des risques.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Tab -->
        <div id="devices-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Gestion des Dispositifs Invasifs</h2>
                        <button onclick="showAddDeviceModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Nouveau dispositif
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="all-devices-list" class="space-y-4">
                        <!-- All devices will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Patient Modal -->
    <div id="add-patient-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Nouveau patient</h3>
                <button onclick="hideAddPatientModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-patient-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nom</label>
                    <input type="text" name="lastName" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Prénom</label>
                    <input type="text" name="firstName" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Âge</label>
                    <input type="number" name="age" required min="0" max="120" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Chambre</label>
                    <input type="text" name="room" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Diagnostic principal</label>
                    <input type="text" name="diagnosis" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideAddPatientModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        Annuler
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg">
                        Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Device Modal -->
    <div id="add-device-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-procedures mr-2"></i>Ajouter un dispositif invasif
                </h3>
                <button onclick="hideAddDeviceModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-device-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Patient</label>
                    <select name="patientId" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="">Sélectionner un patient</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type de dispositif</label>
                    <select name="deviceType" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                        <option value="">Sélectionner un type</option>
                        <option value="catheter-central">Cathéter Central</option>
                        <option value="catheter-peripherique">Cathéter Périphérique</option>
                        <option value="sonde-urinaire">Sonde Urinaire</option>
                        <option value="intubation">Intubation Endotrachéale</option>
                        <option value="drain-thoracique">Drain Thoracique</option>
                        <option value="sonde-nasogastrique">Sonde Nasogastrique</option>
                        <option value="catheter-epidural">Cathéter Épidural</option>
                        <option value="pace-maker-temp">Pace-maker Temporaire</option>
                        <option value="dialyse">Cathéter de Dialyse</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Localisation</label>
                    <input type="text" name="location" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base" placeholder="Ex: Veine jugulaire droite">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date/Heure d'insertion</label>
                    <input type="datetime-local" name="insertionTime" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
                    <textarea name="notes" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-base" placeholder="Notes additionnelles..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideAddDeviceModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                        Annuler
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg">
                        Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Database simulation avec stockage local
        let patients = JSON.parse(localStorage.getItem('carerisk-patients') || '[]') || [
            {
                id: 1,
                firstName: "Marie",
                lastName: "Durand",
                age: 78,
                room: "101A",
                diagnosis: "Fracture du col du fémur",
                admissionDate: "2024-01-10"
            },
            {
                id: 2,
                firstName: "Jean",
                lastName: "Martin",
                age: 65,
                room: "102B",
                diagnosis: "Post-opératoire chirurgie cardiaque",
                admissionDate: "2024-01-12"
            },
            {
                id: 3,
                firstName: "Sophie",
                lastName: "Leblanc",
                age: 82,
                room: "103A",
                diagnosis: "Pneumonie",
                admissionDate: "2024-01-08"
            }
        ];

        let carePlans = JSON.parse(localStorage.getItem('carerisk-careplans') || '[]') || [];
        let invasiveDevices = JSON.parse(localStorage.getItem('carerisk-devices') || '[]') || [];
        let currentPatientId = null;

        // Sauvegarder les données automatiquement
        function saveData() {
            localStorage.setItem('carerisk-patients', JSON.stringify(patients));
            localStorage.setItem('carerisk-careplans', JSON.stringify(carePlans));
            localStorage.setItem('carerisk-devices', JSON.stringify(invasiveDevices));
        }

        // Types de dispositifs avec durées recommandées
        const deviceTypes = {
            'catheter-central': { name: 'Cathéter Central', maxDuration: 168, warningDuration: 120, riskScore: 2 },
            'catheter-peripherique': { name: 'Cathéter Périphérique', maxDuration: 96, warningDuration: 72, riskScore: 1 },
            'sonde-urinaire': { name: 'Sonde Urinaire', maxDuration: 720, warningDuration: 600, riskScore: 1 },
            'intubation': { name: 'Intubation Endotrachéale', maxDuration: 336, warningDuration: 240, riskScore: 2 },
            'drain-thoracique': { name: 'Drain Thoracique', maxDuration: 240, warningDuration: 168, riskScore: 2 },
            'sonde-nasogastrique': { name: 'Sonde Nasogastrique', maxDuration: 168, warningDuration: 120, riskScore: 1 },
            'catheter-epidural': { name: 'Cathéter Épidural', maxDuration: 72, warningDuration: 48, riskScore: 1 },
            'pace-maker-temp': { name: 'Pace-maker Temporaire', maxDuration: 240, warningDuration: 168, riskScore: 2 },
            'dialyse': { name: 'Cathéter de Dialyse', maxDuration: 720, warningDuration: 600, riskScore: 2 },
            'autre': { name: 'Autre', maxDuration: 72, warningDuration: 48, riskScore: 1 }
        };

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.add('active');

            if (tabName === 'devices') {
                loadAllDevices();
            }
        }

        // Patient management
        function loadPatients() {
            const patientsList = document.getElementById('patients-list');
            const patientSelect = document.getElementById('patient-select');
            
            patientsList.innerHTML = '';
            patientSelect.innerHTML = '<option value="">Sélectionner un patient...</option>';
            
            patients.forEach(patient => {
                const patientCard = document.createElement('div');
                patientCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                patientCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="bg-primary text-white w-12 h-12 rounded-full flex items-center justify-center font-bold">
                                ${patient.firstName[0]}${patient.lastName[0]}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white">${patient.firstName} ${patient.lastName}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${patient.age} ans • Chambre ${patient.room}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-500">${patient.diagnosis}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500 dark:text-gray-500">Admission</p>
                            <p class="text-sm font-medium text-gray-900 dark:text-white">${new Date(patient.admissionDate).toLocaleDateString('fr-FR')}</p>
                        </div>
                    </div>
                `;
                patientsList.appendChild(patientCard);
                
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.firstName} ${patient.lastName} - Ch. ${patient.room}`;
                patientSelect.appendChild(option);
            });
        }

        function showAddPatientModal() {
            document.getElementById('add-patient-modal').classList.remove('hidden');
        }

        function hideAddPatientModal() {
            document.getElementById('add-patient-modal').classList.add('hidden');
            document.getElementById('add-patient-form').reset();
        }

        // Device management
        function showAddDeviceModal() {
            const modal = document.getElementById('add-device-modal');
            const patientSelect = document.querySelector('#add-device-form select[name="patientId"]');
            
            patientSelect.innerHTML = '<option value="">Sélectionner un patient</option>';
            patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.firstName} ${patient.lastName} - Ch. ${patient.room}`;
                patientSelect.appendChild(option);
            });
            
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.querySelector('input[name="insertionTime"]').value = now.toISOString().slice(0, 16);
            
            modal.classList.remove('hidden');
        }

        function hideAddDeviceModal() {
            document.getElementById('add-device-modal').classList.add('hidden');
            document.getElementById('add-device-form').reset();
        }

        function loadAllDevices() {
            const devicesList = document.getElementById('all-devices-list');
            
            if (invasiveDevices.length === 0) {
                devicesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Aucun dispositif invasif enregistré</p>';
                return;
            }
            
            devicesList.innerHTML = '';
            
            invasiveDevices.forEach(device => {
                const patient = patients.find(p => p.id === device.patientId);
                const deviceInfo = deviceTypes[device.deviceType];
                const now = new Date();
                const duration = Math.floor((now - new Date(device.insertionTime)) / (1000 * 60 * 60));
                
                let statusColor = 'text-green-600 dark:text-green-400';
                let statusText = 'OK';
                let statusIcon = 'fas fa-check-circle';
                
                if (duration >= deviceInfo.maxDuration) {
                    statusColor = 'text-red-600 dark:text-red-400';
                    statusText = 'URGENT - À retirer';
                    statusIcon = 'fas fa-exclamation-triangle';
                } else if (duration >= deviceInfo.warningDuration) {
                    statusColor = 'text-yellow-600 dark:text-yellow-400';
                    statusText = 'Attention - Contrôler';
                    statusIcon = 'fas fa-clock';
                }
                
                const deviceCard = document.createElement('div');
                deviceCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
                deviceCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-gray-900 dark:text-white">${deviceInfo.name}</h4>
                                <div class="flex items-center space-x-2">
                                    <i class="${statusIcon} ${statusColor}"></i>
                                    <span class="text-sm font-medium ${statusColor}">${statusText}</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                <strong>Patient:</strong> ${patient ? `${patient.firstName} ${patient.lastName} (${patient.room})` : 'Inconnu'}
                            </p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                <strong>Localisation:</strong> ${device.location}
                            </p>
                            <div class="flex items-center justify-between mt-2">
                                <p class="text-xs text-gray-500 dark:text-gray-500">
                                    Inséré: ${new Date(device.insertionTime).toLocaleDateString('fr-FR')} ${new Date(device.insertionTime).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-500">
                                    Durée: ${duration}h / ${deviceInfo.maxDuration}h max
                                </p>
                            </div>
                            ${device.notes ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-1"><strong>Notes:</strong> ${device.notes}</p>` : ''}
                        </div>
                        <button onclick="removeDevice(${device.id})" class="ml-3 text-red-500 hover:text-red-700 dark:hover:text-red-300">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                `;
                devicesList.appendChild(deviceCard);
            });
        }

        function removeDevice(deviceId) {
            showConfirmDialog('Êtes-vous sûr de vouloir retirer ce dispositif ?', () => {
                invasiveDevices = invasiveDevices.filter(d => d.id !== deviceId);
                loadAllDevices();
                loadDevicesList();
                calculateDevicesScore();
                saveData();
            });
        }

        function loadDevicesList() {
            const devicesList = document.getElementById('invasive-devices-list');
            const patientDevices = invasiveDevices.filter(d => d.patientId === currentPatientId);
            
            if (patientDevices.length === 0) {
                devicesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm italic">Aucun dispositif invasif enregistré</p>';
                return;
            }
            
            devicesList.innerHTML = '';
            
            patientDevices.forEach(device => {
                const deviceInfo = deviceTypes[device.deviceType];
                const now = new Date();
                const duration = Math.floor((now - new Date(device.insertionTime)) / (1000 * 60 * 60));
                
                let statusColor = 'text-green-600 dark:text-green-400';
                let statusText = 'OK';
                let statusIcon = 'fas fa-check-circle';
                
                if (duration >= deviceInfo.maxDuration) {
                    statusColor = 'text-red-600 dark:text-red-400';
                    statusText = 'URGENT - À retirer';
                    statusIcon = 'fas fa-exclamation-triangle';
                } else if (duration >= deviceInfo.warningDuration) {
                    statusColor = 'text-yellow-600 dark:text-yellow-400';
                    statusText = 'Attention - Contrôler';
                    statusIcon = 'fas fa-clock';
                }
                
                const deviceCard = document.createElement('div');
                deviceCard.className = 'flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                deviceCard.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <h4 class="font-medium text-gray-900 dark:text-white">${deviceInfo.name}</h4>
                            <div class="flex items-center space-x-2">
                                <i class="${statusIcon} ${statusColor}"></i>
                                <span class="text-xs font-medium ${statusColor}">${statusText}</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${device.location}</p>
                        <div class="flex items-center justify-between mt-1">
                            <p class="text-xs text-gray-500 dark:text-gray-500">
                                Inséré: ${new Date(device.insertionTime).toLocaleDateString('fr-FR')} ${new Date(device.insertionTime).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-500">
                                Durée: ${duration}h / ${deviceInfo.maxDuration}h max
                            </p>
                        </div>
                        ${device.notes ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${device.notes}</p>` : ''}
                    </div>
                    <button onclick="removeDevice(${device.id})" class="ml-3 text-red-500 hover:text-red-700 dark:hover:text-red-300">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                `;
                devicesList.appendChild(deviceCard);
            });
        }

        function calculateDevicesScore() {
            if (!currentPatientId) return 0;
            
            const patientDevices = invasiveDevices.filter(d => d.patientId === currentPatientId);
            let score = 0;
            
            if (patientDevices.length === 0) {
                score = 0;
            } else if (patientDevices.length === 1) {
                score = 1;
            } else {
                score = 2;
            }
            
            const highRiskDevices = patientDevices.filter(d => deviceTypes[d.deviceType].riskScore === 2);
            if (highRiskDevices.length > 0) {
                score = Math.min(score + 1, 2);
            }
            
            document.getElementById('devices-score').textContent = score;
            return score;
        }

        // Patient selection for evaluation
        document.getElementById('patient-select').addEventListener('change', function(e) {
            const patientId = e.target.value;
            if (patientId) {
                currentPatientId = parseInt(patientId);
                document.getElementById('evaluation-form').classList.remove('hidden');
                loadDevicesList();
                calculateDevicesScore();
            } else {
                currentPatientId = null;
                document.getElementById('evaluation-form').classList.add('hidden');
            }
        });

        // Risk calculation functions
        function calculateBradenScore() {
            const fields = ['braden-sensation', 'braden-moisture', 'braden-activity', 'braden-mobility', 'braden-nutrition', 'braden-friction'];
            let total = 0;
            
            fields.forEach(field => {
                const value = parseInt(document.querySelector(`select[name="${field}"]`).value) || 0;
                total += value;
            });
            
            document.getElementById('braden-score').textContent = total;
            
            let riskLevel, riskColor;
            if (total <= 9) {
                riskLevel = "Risque très élevé";
                riskColor = "text-red-600 dark:text-red-400";
            } else if (total <= 12) {
                riskLevel = "Risque élevé";
                riskColor = "text-red-500 dark:text-red-300";
            } else if (total <= 14) {
                riskLevel = "Risque modéré";
                riskColor = "text-yellow-600 dark:text-yellow-400";
            } else if (total <= 18) {
                riskLevel = "Risque faible";
                riskColor = "text-yellow-500 dark:text-yellow-300";
            } else {
                riskLevel = "Risque minimal";
                riskColor = "text-green-600 dark:text-green-400";
            }
            
            const riskElement = document.getElementById('braden-risk');
            riskElement.textContent = riskLevel;
            riskElement.className = `text-sm font-medium ${riskColor}`;
            
            return { score: total, level: riskLevel };
        }

        function calculateMorseScore() {
            const fields = ['morse-history', 'morse-diagnosis', 'morse-aid', 'morse-iv', 'morse-gait', 'morse-mental'];
            let total = 0;
            
            fields.forEach(field => {
                const value = parseInt(document.querySelector(`select[name="${field}"]`).value) || 0;
                total += value;
            });
            
            document.getElementById('morse-score').textContent = total;
            
            let riskLevel, riskColor;
            if (total >= 45) {
                riskLevel = "Risque élevé";
                riskColor = "text-red-600 dark:text-red-400";
            } else if (total >= 25) {
                riskLevel = "Risque modéré";
                riskColor = "text-yellow-600 dark:text-yellow-400";
            } else {
                riskLevel = "Risque faible";
                riskColor = "text-green-600 dark:text-green-400";
            }
            
            const riskElement = document.getElementById('morse-risk');
            riskElement.textContent = riskLevel;
            riskElement.className = `text-sm font-medium ${riskColor}`;
            
            return { score: total, level: riskLevel };
        }

        function calculateInfectionScore() {
            const fields = ['infection-age', 'infection-immune', 'infection-antibiotics', 'infection-surgery', 'infection-comorbid'];
            let total = 0;
            
            fields.forEach(field => {
                const value = parseInt(document.querySelector(`select[name="${field}"]`).value) || 0;
                total += value;
            });
            
            total += calculateDevicesScore();
            
            document.getElementById('infection-score').textContent = total;
            
            let riskLevel, riskColor;
            if (total >= 6) {
                riskLevel = "Risque élevé";
                riskColor = "text-red-600 dark:text-red-400";
            } else if (total >= 3) {
                riskLevel = "Risque modéré";
                riskColor = "text-yellow-600 dark:text-yellow-400";
            } else {
                riskLevel = "Risque faible";
                riskColor = "text-green-600 dark:text-green-400";
            }
            
            const riskElement = document.getElementById('infection-risk');
            riskElement.textContent = riskLevel;
            riskElement.className = `text-sm font-medium ${riskColor}`;
            
            return { score: total, level: riskLevel };
        }

        function calculateRisks() {
            const bradenResult = calculateBradenScore();
            const morseResult = calculateMorseScore();
            const infectionResult = calculateInfectionScore();
            
            window.lastAssessment = {
                patientId: currentPatientId,
                braden: bradenResult,
                morse: morseResult,
                infection: infectionResult,
                devices: invasiveDevices.filter(d => d.patientId === currentPatientId),
                date: new Date().toISOString(),
                nurseAssessedBy: document.getElementById('nurse-name').value
            };

            showCustomAlert('Évaluation calculée avec succès ! Vous pouvez maintenant générer le plan de soins.');
        }

        function generateCarePlan() {
            if (!window.lastAssessment || !currentPatientId) {
                showCustomAlert('Veuillez d\'abord effectuer une évaluation des risques.');
                return;
            }
            
            const patient = patients.find(p => p.id === currentPatientId);
            const assessment = window.lastAssessment;
            
            const carePlan = {
                id: carePlans.length + 1,
                patientId: currentPatientId,
                patientName: `${patient.firstName} ${patient.lastName}`,
                date: new Date().toLocaleDateString('fr-FR'),
                assessment: assessment,
                interventions: generateInterventions(assessment)
            };
            
            carePlans.push(carePlan);
            saveData();
            loadCarePlans();
            showTab('plans');
            
            showCustomAlert('Plan de soins généré avec succès !');
        }

        function generateInterventions(assessment) {
            const interventions = [];
            
            if (assessment.braden.score <= 18) {
                interventions.push({
                    category: 'Prévention des escarres',
                    priority: assessment.braden.score <= 12 ? 'Élevée' : 'Modérée',
                    actions: [
                        'Retournements toutes les 2 heures',
                        'Utilisation de matelas anti-escarres',
                        'Inspection quotidienne de la peau',
                        'Maintien de l\'hygiène et de la sécheresse',
                        'Nutrition et hydratation optimales',
                        'Mobilisation selon capacités'
                    ]
                });
            }
            
            if (assessment.morse.score >= 25) {
                interventions.push({
                    category: 'Prévention des chutes',
                    priority: assessment.morse.score >= 45 ? 'Élevée' : 'Modérée',
                    actions: [
                        'Surveillance renforcée',
                        'Lit en position basse',
                        'Barrières de lit si appropriées',
                        'Aide à la mobilisation',
                        'Éclairage nocturne',
                        'Objets personnels à portée',
                        'Chaussures antidérapantes',
                        'Évaluation régulière des médicaments'
                    ]
                });
            }
            
            if (assessment.infection.score >= 3) {
                const actions = [
                    'Hygiène des mains stricte',
                    'Surveillance des signes vitaux',
                    'Surveillance des symptômes infectieux',
                    'Isolement si nécessaire',
                    'Administration appropriée des antibiotiques',
                    'Nutrition et immunité'
                ];
                
                if (assessment.devices && assessment.devices.length > 0) {
                    actions.push('Soins quotidiens des dispositifs invasifs');
                    actions.push('Surveillance des points d\'insertion');
                    actions.push('Changement des pansements selon protocole');
                    actions.push('Évaluation quotidienne de la nécessité des dispositifs');
                    
                    assessment.devices.forEach(device => {
                        const deviceInfo = deviceTypes[device.deviceType];
                        const now = new Date();
                        const duration = Math.floor((now - new Date(device.insertionTime)) / (1000 * 60 * 60));
                        
                        if (duration >= deviceInfo.warningDuration) {
                            actions.push(`${deviceInfo.name} (${device.location}): évaluer la nécessité du maintien`);
                        }
                    });
                }
                
                interventions.push({
                    category: 'Prévention des infections',
                    priority: assessment.infection.score >= 6 ? 'Élevée' : 'Modérée',
                    actions: actions
                });
            }
            
            return interventions;
        }

        function loadCarePlans() {
            const careplansList = document.getElementById('care-plans-list');
            
            if (carePlans.length === 0) {
                careplansList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Aucun plan de soins généré. Effectuez d\'abord une évaluation des risques.</p>';
                return;
            }
            
            careplansList.innerHTML = '';
            
            carePlans.forEach(plan => {
                const planCard = document.createElement('div');
                planCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-6';
                
                let interventionsHtml = '';
                plan.interventions.forEach(intervention => {
                    const priorityColor = intervention.priority === 'Élevée' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    
                    interventionsHtml += `
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-gray-900 dark:text-white">${intervention.category}</h4>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityColor}">
                                    Priorité ${intervention.priority}
                                </span>
                            </div>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-600 dark:text-gray-300">
                                ${intervention.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
                
                let devicesHtml = '';
                if (plan.assessment.devices && plan.assessment.devices.length > 0) {
                    devicesHtml = `
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-2">
                                <i class="fas fa-procedures mr-2"></i>Dispositifs invasifs en place
                            </h4>
                            <div class="space-y-2">
                                ${plan.assessment.devices.map(device => {
                                    const deviceInfo = deviceTypes[device.deviceType];
                                    const duration = Math.floor((new Date(plan.assessment.date) - new Date(device.insertionTime)) / (1000 * 60 * 60));
                                    return `
                                        <div class="text-sm bg-gray-50 dark:bg-gray-700 p-2 rounded">
                                            <strong>${deviceInfo.name}</strong> - ${device.location}
                                            <br>Durée: ${duration}h / ${deviceInfo.maxDuration}h max
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                planCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${plan.patientName}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Plan généré le ${plan.date}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-500">Évaluateur: ${plan.assessment.nurseAssessedBy}</p>
                        </div>
                        <div class="text-right text-sm">
                            <p class="text-gray-600 dark:text-gray-400">Scores d'évaluation:</p>
                            <p class="text-gray-900 dark:text-white">Braden: ${plan.assessment.braden.score}/23</p>
                            <p class="text-gray-900 dark:text-white">Morse: ${plan.assessment.morse.score}/125</p>
                            <p class="text-gray-900 dark:text-white">Infection: ${plan.assessment.infection.score}/10</p>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        ${devicesHtml}
                        ${interventionsHtml}
                    </div>
                `;
                
                careplansList.appendChild(planCard);
            });
        }

        // Form submissions
        document.getElementById('add-patient-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newPatient = {
                id: patients.length + 1,
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                age: parseInt(formData.get('age')),
                room: formData.get('room'),
                diagnosis: formData.get('diagnosis'),
                admissionDate: new Date().toISOString().split('T')[0]
            };
            
            patients.push(newPatient);
            saveData();
            loadPatients();
            hideAddPatientModal();
            showCustomAlert('Patient ajouté avec succès !');
        });

        document.getElementById('add-device-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const deviceData = {
                id: invasiveDevices.length + 1,
                patientId: parseInt(formData.get('patientId')),
                deviceType: formData.get('deviceType'),
                location: formData.get('location'),
                insertionTime: formData.get('insertionTime'),
                notes: formData.get('notes'),
                addedBy: document.getElementById('nurse-name').value
            };
            
            invasiveDevices.push(deviceData);
            saveData();
            hideAddDeviceModal();
            loadAllDevices();
            loadDevicesList();
            calculateDevicesScore();
            showCustomAlert('Dispositif ajouté avec succès !');
        });

        // Auto-calculate scores on change
        document.addEventListener('change', function(e) {
            if (e.target.name && e.target.name.startsWith('braden-')) {
                calculateBradenScore();
            } else if (e.target.name && e.target.name.startsWith('morse-')) {
                calculateMorseScore();
            } else if (e.target.name && e.target.name.startsWith('infection-')) {
                calculateInfectionScore();
            }
        });

        // Custom dialog functions
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-info-circle text-primary mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Information</h3>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-question-circle text-yellow-500 mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmation</h3>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded" onclick="this.closest('.fixed').remove(); (${onConfirm})()">Confirmer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // CSS for tab buttons
        const style = document.createElement('style');
        style.textContent = `
            .tab-button {
                color: #6B7280;
            }
            .tab-button.active {
                background-color: #5D5CDE;
                color: white;
            }
            .tab-button:not(.active):hover {
                background-color: #F3F4F6;
                color: #374151;
            }
            .dark .tab-button:not(.active):hover {
                background-color: #374151;
                color: #D1D5DB;
            }
        `;
        document.head.appendChild(style);

        // PWA Installation
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Installer App';
            installBtn.className = 'fixed bottom-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg hover:bg-primary/90 transition-colors z-50';
            installBtn.onclick = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            installBtn.remove();
                        }
                    });
                } else {
                    showCustomAlert('Pour installer: Menu navigateur > "Installer CareRisk" ou "Ajouter à l\'écran d\'accueil"');
                }
            };
            document.body.appendChild(installBtn);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();
            loadCarePlans();
        });
    </script>
        <script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const dashboardContainer = document.querySelector('.container');

    function showDashboard(user){
        if (loginForm) loginForm.style.display = 'none';
        if (dashboardContainer) dashboardContainer.style.opacity = '1';
    }
    window.logout = function() {
        localStorage.removeItem('carerisk_user');
        window.location.reload();
    }
    const user = JSON.parse(localStorage.getItem('carerisk_user') || 'null');
    if(user && user.fullname && user.email && user.service){
        showDashboard(user);
    }else{
        if (dashboardContainer) dashboardContainer.style.opacity = '0.2';
    }
    if(loginForm){
        loginForm.addEventListener('submit', function(e){
            e.preventDefault();
            const fullname = document.getElementById('fullname').value.trim();
            const email = document.getElementById('email').value.trim();
            const service = document.getElementById('service').value;
            if(!fullname || !email || !service) {
                alert('Veuillez remplir tous les champs.');
                return;
            }
            localStorage.setItem('carerisk_user', JSON.stringify({fullname, email, service}));
            showDashboard({fullname, email, service});
        });
    }
});
</script>
</body>
</html>
